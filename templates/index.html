{% extends "base.html" %}

{% block title %}RankSewa - Find Doctors in Nepal Based on Patient Reviews and Ratings{% endblock %}

{% block meta_description %}Find and compare 28,000+ doctors in Nepal based on real patient reviews. Search by specialty and city in Kathmandu, Pokhara, Biratnagar, and across Nepal. Check NMC credentials, read verified patient experiences, and discover trusted healthcare providers near you.{% endblock %}

{% block meta_keywords %}find doctors in Nepal, doctor reviews Nepal, NMC verified doctors, doctors in Kathmandu, doctors in Pokhara, Nepal healthcare directory, patient reviews, medical professionals Nepal, specialist doctors Nepal, doctor ratings Nepal, RankSewa{% endblock %}

{% block og_title %}RankSewa - Find Trusted Doctors in Nepal | Patient Reviews & Ratings{% endblock %}
{% block og_description %}Discover and compare doctors in Nepal based on real patient experiences. Search 28,000+ doctors by specialty and city. Read verified reviews, check NMC numbers, and find trusted healthcare providers near you.{% endblock %}

{% block twitter_title %}RankSewa - Find Doctors in Nepal | Patient Reviews{% endblock %}
{% block twitter_description %}Search 28,000+ doctors in Nepal by specialty and city. Read real patient reviews, check credentials, and find trusted healthcare providers.{% endblock %}

{% block content %}
<!-- Promotional Banner -->
{% include 'partials/promo_banner.html' %}

<!-- Hero + Search -->
<div class="row mb-4 homepage-hero">
    <div class="col-12">
        <div class="hero-card">
            <div class="row g-4 align-items-center">
                <div class="col-lg-6">
                    <span class="eyebrow">Nepal’s doctor directory powered by patient experiences</span>
                    <h1 class="display-5 fw-bold mb-3 text-brand">
                        Find Doctors in Nepal Based on Patient Reviews
                    </h1>
                    <p class="lead text-muted mb-4">
                        Search by city and specialty, read real experiences, and choose with confidence. Doctors can claim profiles and add verified details.
                    </p>

                    <div class="trust-strip mb-4">
                        <div class="trust-item">
                            <i class="fas fa-shield-alt me-2 text-brand"></i>NMC number checked (when available)
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-star me-2 text-brand"></i>Real patient reviews
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-map-marker-alt me-2 text-brand"></i>Nationwide coverage
                        </div>
                    </div>

                    <div class="d-flex flex-wrap gap-3">
                        <a href="#searchSection" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>Search Doctors
                        </a>
                        <a href="#whyReviewsMatter" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-pen me-2"></i>Rate a Doctor
                        </a>
                    </div>

                    <p class="text-muted small mt-3 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        Reviews should be respectful and based on personal experience.
                    </p>
                </div>

                <div class="col-lg-6">
                    <div class="search-container search-card search-card--primary" id="searchSection">
                        <h3 class="text-center">
                            <i class="fas fa-search me-2"></i>Search Doctors in Nepal
                        </h3>
                        <p class="text-center text-muted mb-3">Search by name, city, or specialty</p>
                        <p class="text-center text-muted small mb-4">
                            Tip: Try city + specialty first (fastest), then narrow by name.
                        </p>

                        <form id="filterForm">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="nameSearch" class="form-label">
                                        <i class="fas fa-user-md me-2"></i>Doctor name
                                    </label>
                                    <input type="text" id="nameSearch" class="form-control" placeholder="e.g., Dr. S. K. Aryal" autocomplete="off">
                                    <small class="text-muted">Press Enter or click Search to see results.</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="citySelect" class="form-label">
                                        <i class="fas fa-map-marker-alt me-2"></i>Select city
                                    </label>
                                    <select id="citySelect" class="form-select">
                                        <option value="">All Cities</option>
                                        {% for city in cities %}
                                        <option value="{{ city.id }}">{{ city.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="specialtySelect" class="form-label">
                                        <i class="fas fa-stethoscope me-2"></i>Select specialty
                                    </label>
                                    <select id="specialtySelect" class="form-select">
                                        <option value="">All Specialties</option>
                                        {% for specialty in specialties %}
                                        <option value="{{ specialty.id }}">{{ specialty.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-12 text-center">
                                    <button type="button" id="filterBtn" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-search me-2"></i>Search Doctors
                                    </button>
                                    <small class="text-muted d-block mt-2">Results appear below the search box.</small>
                                </div>
                            </div>

                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    Results update automatically when you change filters.
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div><!-- /row -->
        </div><!-- /hero-card -->
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-strip">
            <div class="row text-center g-3">
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-brand">{{ total_doctors }}+</h3>
                    <p class="text-muted mb-0">Doctors listed</p>
                </div>
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-accent">{{ total_cities }}+</h3>
                    <p class="text-muted mb-0">Cities covered</p>
                </div>
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-brand">{{ total_reviews }}+</h3>
                    <p class="text-muted mb-0">Patient reviews</p>
                </div>
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-accent">{{ verified_doctors }}+</h3>
                    <p class="text-muted mb-0">Verified profiles</p>
                </div>
            </div>

            <div class="text-center mt-3">
                <p class="text-muted small mb-0">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    Kathmandu | Lalitpur | Pokhara | Biratnagar | Birtamod
                </p>
            </div>

            <div class="text-center mt-2">
                <p class="text-muted small mb-0">
                    Doctor info is compiled from public sources and self-submitted updates.
                    <strong>Verified</strong> badges mean the profile was reviewed by RankSewa (not an endorsement).
                </p>
            </div>
        </div>
    </div>
</div>

<!-- What is RankSewa Section (for SEO and clarity) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-lg-8 mx-auto text-center">
                        <h2 class="h3 fw-bold mb-3 text-brand">What is RankSewa?</h2>
                        <p class="lead text-muted mb-4">
                            RankSewa is Nepal's comprehensive healthcare directory platform that helps patients find and review doctors based on real patient experiences.
                        </p>
                        <div class="row g-3 text-start">
                            <div class="col-md-6">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-search text-brand fs-5"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="fw-semibold mb-2">Search by City & Specialty</h5>
                                        <p class="text-muted small mb-0">Find doctors across Nepal's major cities including Kathmandu, Pokhara, Biratnagar, and more. Filter by medical specialty to find the right healthcare provider for your needs.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-star text-brand fs-5"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="fw-semibold mb-2">Real Patient Reviews</h5>
                                        <p class="text-muted small mb-0">Read authentic patient experiences and ratings to make informed healthcare decisions. Share your own experience to help others in the community.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-shield-alt text-brand fs-5"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="fw-semibold mb-2">Verified Credentials</h5>
                                        <p class="text-muted small mb-0">Check Nepal Medical Council (NMC) registration numbers and verified doctor profiles. RankSewa reviews doctor-submitted information for accuracy.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-user-md text-brand fs-5"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="fw-semibold mb-2">For Healthcare Providers</h5>
                                        <p class="text-muted small mb-0">Doctors can claim their profiles for free, update their information, respond to reviews, and build trust with potential patients across Nepal.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Doctor Claim Profile CTA -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm overflow-hidden cta-surface">
                    <div class="card-body p-3 p-lg-4">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <div class="d-inline-flex align-items-center gap-2 bg-white border rounded-pill px-3 py-1 mb-3">
                                    <span class="badge bg-success">100% FREE</span>
                                    <small class="fw-semibold text-brand">Launch Offer - Until April 25, 2026</small>
                                </div>
                                <h4 class="mb-2 text-dark">Are You a Doctor? Claim Your Profile</h4>
                                <p class="mb-3 text-muted">
                                    Add accurate details, get a RankSewa Verified badge after review, and respond to patient feedback.
                                </p>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="fas fa-check-circle text-success mt-1"></i>
                                            <span class="small">Show verified details</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="fas fa-check-circle text-success mt-1"></i>
                                            <span class="small">Build patient trust</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="fas fa-check-circle text-success mt-1"></i>
                                            <span class="small">Improve visibility in search</span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-muted small mb-0">
                                    Verification review: typically 2–3 business days (may vary).
                                </p>
                            </div>

                            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('claim_profile') }}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-check-circle me-2"></i>Claim Your Profile
                                    </a>
                                    <a href="{{ url_for('doctor_self_register') }}" class="btn btn-outline-primary btn-lg">
                                        <i class="fas fa-user-plus me-2"></i>Register as New Doctor
                                    </a>
                                </div>
                                <div class="mt-3 small text-success fw-semibold">
                                    <i class="fas fa-gift me-1"></i>100% Free during launch
                                </div>
                            </div>
                        </div><!-- /row -->
                    </div>
                </div>
            </div>
        </div>

        <!-- How RankSewa Helps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h3 class="text-center mb-4">How RankSewa Helps</h3>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="text-center p-3">
                                    <div class="mb-3">
                                        <i class="fas fa-users fa-3x text-brand"></i>
                                    </div>
                                    <h5 class="mb-3">For Patients</h5>
                                    <ul class="list-unstyled text-start" style="max-width: 340px; margin: 0 auto;">
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Read real patient experiences</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Compare doctors by city & specialty</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Choose with more confidence</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3">
                                    <div class="mb-3">
                                        <i class="fas fa-user-md fa-3x text-accent"></i>
                                    </div>
                                    <h5 class="mb-3">For Doctors</h5>
                                    <ul class="list-unstyled text-start" style="max-width: 340px; margin: 0 auto;">
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Claim profile & correct info</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Show experience, workplace, services</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Respond to feedback professionally</li>
                                    </ul>
                                </div>
                            </div>
                        </div><!-- /row -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Why Reviews Matter -->
        <div class="row mb-4" id="whyReviewsMatter">
            <div class="col-12">
                <div class="card border-0 shadow-sm highlight-surface">
                    <div class="card-body p-4 text-center">
                        <h3 class="mb-3">Why Reviews Matter</h3>
                        <p class="lead text-muted" style="max-width: 860px; margin: 0 auto;">
                            Choosing a doctor is a big decision. RankSewa helps people learn from real experiences so
                            good care gets recognized and patients feel safer.
                        </p>

                        <div class="row g-3 mt-4" style="max-width: 920px; margin: 0 auto;">
                            <div class="col-md-4">
                                <div class="p-3 bg-white border rounded-3 h-100">
                                    <div class="fw-bold mb-1"><i class="fas fa-search me-2 text-brand"></i>1) Search</div>
                                    <div class="text-muted small">Find the doctor by name, city, or specialty.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-white border rounded-3 h-100">
                                    <div class="fw-bold mb-1"><i class="fas fa-id-card me-2 text-brand"></i>2) Open profile</div>
                                    <div class="text-muted small">View details, clinic, and existing reviews.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-white border rounded-3 h-100">
                                    <div class="fw-bold mb-1"><i class="fas fa-pen me-2 text-brand"></i>3) Share experience</div>
                                    <div class="text-muted small">Leave a respectful review to help others.</div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <a href="#searchSection" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>Search & Review
                            </a>
                        </div>

                        <p class="text-muted small mt-3 mb-0">
                            <i class="fas fa-shield-alt me-1"></i>
                            RankSewa does not provide medical advice. For emergencies, contact local services immediately.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="row" id="resultsSection">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
                    <h2 class="mb-0">
                        <i class="fas fa-list me-2"></i><span id="resultsTitle">Doctor List</span>
                    </h2>
                    <span id="resultsCount" class="badge bg-primary" style="display: none;"></span>
                </div>
                <p class="text-muted mb-3 small">Verified profiles appear first to help patients choose with confidence.</p>

                <div id="doctorList" class="row">
                    <div class="col-12 text-center py-5">
                        <p class="mt-2">Please use the search filters to find doctors</p>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /col -->
</div><!-- /row -->
{% endblock %}

{% block scripts %}
<!-- Select2 CSS (for searchable dropdowns) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 on city and specialty dropdowns for better UX with 1000+ cities
    $('#citySelect').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search cities...',
        allowClear: true,
        width: '100%'
    });

    $('#specialtySelect').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search specialties...',
        allowClear: true,
        width: '100%'
    });

    loadDoctors(); // Initial load - no scroll

    $('#filterBtn').click(function() {
        loadDoctors(1, true); // User clicked search - scroll to results
    });

    // Use Select2 change event instead of regular change
    $('#citySelect, #specialtySelect').on('select2:select select2:clear', function() {
        loadDoctors(1, false); // Update results without auto-scroll
    });

    // Search as user types (with debounce)
    let searchTimeout;
    $('#nameSearch').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadDoctors(1, false); // Update results without auto-scroll
        }, 500);
    });

    // Prevent form submission when pressing Enter
    $('#filterForm').on('submit', function(e) {
        e.preventDefault(); // Stop form from submitting
        loadDoctors(1, true); // Trigger search and scroll to results
        return false;
    });

    // Also handle Enter key specifically in name search field
    $('#nameSearch').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            clearTimeout(searchTimeout); // Cancel debounce timer
            loadDoctors(1, true); // Immediate search and scroll
            return false;
        }
    });
});

let currentPage = 1;
let shouldScroll = false; // Track if we should scroll after loading doctors

function scrollToResults() {
    if (!shouldScroll) {
        return;
    }

    setTimeout(function() {
        const target = $("#resultsSection");
        if (!target.length) {
            return;
        }

        $('html, body').animate({
            scrollTop: target.offset().top - 100
        }, 600, 'swing');
    }, 100);
}

function loadDoctors(page = 1, scroll = false) {
    const cityId = $('#citySelect').val();
    const specialtyId = $('#specialtySelect').val();
    const nameSearch = $('#nameSearch').val();
    currentPage = page;
    shouldScroll = scroll;

    $('#doctorList').html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status" aria-label="Loading"></div></div>');

    $.ajax({
        url: '/doctors',
        type: 'GET',
        data: {
            city_id: cityId,
            specialty_id: specialtyId,
            name: nameSearch,
            page: page
        },
        success: function(response) {
            displayDoctors(response);
        },
        error: function() {
            $('#doctorList').html('<div class="col-12"><div class="alert alert-danger">Error loading doctors.</div></div>');
        }
    });
}

const isAdmin = {{ 'true' if session.get('is_admin') else 'false' }};

// Generate professional avatar URL for doctors without photos
function getDoctorAvatar(doctorName, doctorId) {
        let cleanedName = doctorName || '';
        const titleRegex = /^\s*(dr|mr|mrs|ms|prof|professor|asst|assistant|assoc|associate)\.?\s+/i;
        while (titleRegex.test(cleanedName)) {
            cleanedName = cleanedName.replace(titleRegex, '');
        }
        cleanedName = cleanedName.trim() || doctorName;
    const colors = ['0D8ABC', '2a9d8f', 'e76f51', 'f4a261', '264653', '9b59b6', '3498db', '16a085'];
    const color = colors[doctorId % colors.length];
    const seed = encodeURIComponent(cleanedName);
    return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}&backgroundColor=${color}`;
}

function displayDoctors(response) {
    const doctors = response.doctors || response; // Handle both old and new format
    const pagination = response.pagination;

    // Update results title and count
    if (pagination && pagination.total_doctors > 0) {
        $('#resultsTitle').text('Search Results');
        $('#resultsCount').text(`${pagination.total_doctors} ${pagination.total_doctors === 1 ? 'doctor' : 'doctors'} found`).show();
    } else {
        $('#resultsTitle').text('Doctor List');
        $('#resultsCount').hide();
    }

    if (!doctors || doctors.length === 0) {
        $('#doctorList').html('<div class="col-12"><div class="alert alert-info">No doctors found matching your search.</div></div>');
        $('#resultsCount').hide();
        scrollToResults();
        return;
    }

    let html = '';
    doctors.forEach(doctor => {
        const ratingCount = doctor.rating_count || 0;
        const hasRatings = ratingCount > 0;
        const avgRating = hasRatings ? parseFloat(doctor.avg_rating).toFixed(1) : '';
        const starHtml = generateStarRatingHtml(doctor.avg_rating, ratingCount);
        const verifiedBadge = doctor.is_verified
            ? '<span class="badge bg-success" style="font-size: 0.65rem; padding: 3px 8px;">✓ Verified</span>'
            : '';
        const clinicLine = doctor.clinic_name
            ? `<p class="card-text text-muted small mb-0"><i class="fas fa-hospital me-1"></i><a href="/clinic/${doctor.clinic_slug}" class="text-muted text-decoration-none">${doctor.clinic_name}</a></p>`
            : '';
        const adminEditButton = isAdmin
            ? `<a href="/admin/doctors/${doctor.id}/edit" class="btn btn-outline-secondary btn-sm ms-2">Edit</a>`
            : '';

        const ratingText = hasRatings
            ? `${avgRating} (${ratingCount} reviews)`
            : `⭐ No reviews yet — <a href="/doctor/${doctor.slug}" class="text-primary">Be the first to review</a>`;

        const imgSrc = doctor.photo_url || getDoctorAvatar(doctor.name, doctor.id);

        html += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card doctor-card h-100 ${doctor.is_featured ? 'featured' : ''} ${doctor.is_verified ? 'verified' : ''}">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="doctor-avatar me-3">
                                <img
                                    src="${imgSrc}"
                                    data-name="${String(doctor.name || '')}"
                                    data-id="${doctor.id}"
                                    class="rounded-circle"
                                    alt="${doctor.name}"
                                    width="80"
                                    height="80"
                                    loading="lazy"
                                    onerror="this.onerror=null; this.src=getDoctorAvatar(this.dataset.name, parseInt(this.dataset.id || '0', 10));"
                                >
                            </div>
                            <div class="doctor-info flex-grow-1">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h5 class="card-title mb-1">${doctor.name}</h5>
                                    ${verifiedBadge}
                                </div>
                                <p class="card-text text-muted mb-1">${doctor.specialty_name}</p>
                                <p class="card-text text-muted small mb-0"><i class="fas fa-map-marker-alt me-1"></i>${doctor.city_name}</p>
                                ${clinicLine}
                            </div>
                        </div>

                        <div class="doctor-details">
                            ${doctor.is_verified && doctor.nmc_number ? `<p class="card-text small mb-1"><strong>NMC#:</strong> ${doctor.nmc_number}</p>` : ''}
                            ${doctor.experience && doctor.experience > 0 ? `<p class="card-text small mb-1"><strong>Experience:</strong> ${doctor.experience} years</p>` : ''}
                            ${doctor.education ? `<p class="card-text small mb-1"><strong>Education:</strong> ${doctor.education}</p>` : ''}
                            ${doctor.college ? `<p class="card-text small mb-1"><strong>College:</strong> ${doctor.college}</p>` : ''}
                            ${doctor.workplace ? `<p class="card-text small mb-1"><strong>Works At:</strong> ${doctor.workplace}</p>` : ''}

                            <div class="d-flex align-items-center mb-2">
                                <div class="rating me-2">
                                    ${starHtml}
                                </div>
                                <span class="text-muted small">${ratingText}</span>
                            </div>

                            <p class="card-text small text-muted">${doctor.description}</p>
                        </div>

                        <div class="d-flex align-items-center">
                            <a href="/doctor/${doctor.slug}" class="btn btn-outline-primary btn-sm">View Profile</a>
                            ${adminEditButton}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    $('#doctorList').html(html);

    // Add pagination if available
    if (pagination && pagination.total_pages > 1) {
        let paginationHtml = '<div class="col-12"><nav aria-label="Doctor results pagination"><ul class="pagination justify-content-center mt-4">';

        // Previous button
        if (pagination.has_prev) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${pagination.page - 1}, true); return false;">Previous</a></li>`;
        } else {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">Previous</span></li>';
        }

        // Page numbers (show max 5 pages at a time)
        let startPage = Math.max(1, pagination.page - 2);
        let endPage = Math.min(pagination.total_pages, pagination.page + 2);

        if (startPage > 1) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(1, true); return false;">1</a></li>`;
            if (startPage > 2) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            if (i === pagination.page) {
                paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${i}, true); return false;">${i}</a></li>`;
            }
        }

        if (endPage < pagination.total_pages) {
            if (endPage < pagination.total_pages - 1) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${pagination.total_pages}, true); return false;">${pagination.total_pages}</a></li>`;
        }

        // Next button
        if (pagination.has_next) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${pagination.page + 1}, true); return false;">Next</a></li>`;
        } else {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">Next</span></li>';
        }

        paginationHtml += '</ul></nav>';
        paginationHtml += `<p class="text-center text-muted small">Showing page ${pagination.page} of ${pagination.total_pages} (${pagination.total_doctors} doctors total)</p>`;
        paginationHtml += '</div>';

        $('#doctorList').append(paginationHtml);

    }

    // Only scroll to results if user actively searched/filtered/paginated (not on initial load)
    scrollToResults();
}

function generateStarRatingHtml(rating, ratingCount) {
    if (!ratingCount) {
        return '';
    }

    let html = '';
    const numericRating = parseFloat(rating);
    const fullStars = Math.floor(numericRating);
    const hasHalfStar = (numericRating - fullStars) >= 0.5;

    for (let i = 0; i < fullStars; i++) {
        html += '<i class="fas fa-star text-warning"></i>';
    }

    if (hasHalfStar) {
        html += '<i class="fas fa-star-half-alt text-warning"></i>';
    }

    const emptyStars = 5 - Math.ceil(numericRating);
    for (let i = 0; i < emptyStars; i++) {
        html += '<i class="far fa-star text-warning"></i>';
    }

    return html;
}
</script>

<!-- Structured Data (JSON-LD) for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "{{ request.url_root }}#organization",
      "name": "RankSewa",
      "url": "{{ request.url_root }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ request.url_root }}static/img/logo.png",
        "width": 512,
        "height": 512
      },
      "description": "Nepal's premier healthcare directory platform helping patients find and review doctors based on real experiences. Compare doctors by specialty, city, and patient ratings.",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "NP",
        "addressRegion": "Bagmati",
        "addressLocality": "Kathmandu"
      },
      "areaServed": {
        "@type": "Country",
        "name": "Nepal"
      },
      "sameAs": [
        "https://www.facebook.com/ranksewa",
        "https://twitter.com/ranksewa",
        "https://www.linkedin.com/company/ranksewa",
        "https://www.instagram.com/ranksewa"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "{{ request.url_root }}#website",
      "url": "{{ request.url_root }}",
      "name": "RankSewa - Find Doctors in Nepal",
      "description": "Find and review doctors in Nepal based on patient experiences. Search by specialty, city, and read verified patient reviews.",
      "publisher": {
        "@id": "{{ request.url_root }}#organization"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "{{ request.url_root }}search?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      },
      "inLanguage": "en-US"
    },
    {
      "@type": "WebPage",
      "@id": "{{ request.url }}#webpage",
      "url": "{{ request.url }}",
      "name": "RankSewa - Find Doctors in Nepal Based on Patient Reviews",
      "isPartOf": {
        "@id": "{{ request.url_root }}#website"
      },
      "about": {
        "@id": "{{ request.url_root }}#organization"
      },
      "description": "Discover and compare 28,000+ doctors in Nepal. Search by specialty and city, read real patient reviews, check NMC credentials, and find trusted healthcare providers.",
      "inLanguage": "en-US"
    },
    {
      "@type": "MedicalOrganization",
      "name": "RankSewa Healthcare Directory",
      "url": "{{ request.url_root }}",
      "description": "Comprehensive healthcare directory for Nepal featuring {{ total_doctors }}+ doctors across {{ total_cities }}+ cities with {{ total_reviews }}+ patient reviews",
      "medicalSpecialty": [
        "Cardiology", "Dermatology", "Pediatrics", "Orthopedics", "Gynecology",
        "Neurology", "Ophthalmology", "ENT", "General Medicine", "Dentistry"
      ]
    }
  ]
}
</script>
{% endblock %}
