{% extends "base.html" %}

{% block title %}RankSewa - Find Doctors in Nepal Based on Patient Reviews and Ratings{% endblock %}

{% block meta_description %}Find and compare {{ total_doctors|default(28000) }}+ doctors in Nepal. Search by specialty and city, verify NMC credentials, and read patient experiences. Discover trusted healthcare providers across Kathmandu, Pokhara, Biratnagar, and all of Nepal.{% endblock %}

{% block meta_keywords %}find doctors in Nepal, doctor reviews Nepal, NMC verified doctors, doctors in Kathmandu, doctors in Pokhara, Nepal healthcare directory, patient reviews, medical professionals Nepal, specialist doctors Nepal, doctor ratings Nepal, RankSewa{% endblock %}

{% block og_title %}RankSewa - Transparent Healthcare in Nepal | Find Doctors Based on Real Patient Experiences{% endblock %}
{% block og_description %}Concerned about healthcare quality? Verify NMC credentials, read patient experiences, and make informed decisions. {{ total_doctors|default(28000) }}+ doctors with verified profiles - because you deserve better healthcare.{% endblock %}

{% block twitter_title %}RankSewa - Transparent Healthcare | Real Patient Reviews{% endblock %}
{% block twitter_description %}Find trustworthy doctors in Nepal through real patient reviews and verified credentials. Healthcare transparency starts here.{% endblock %}

{% block og_image %}{{ request.url_root }}static/img/social-share.png{% endblock %}
{% block twitter_image %}{{ request.url_root }}static/img/social-share.png{% endblock %}

{% block content %}
<!-- Promotional Banner -->
{% include 'partials/promo_banner.html' %}

<!-- Hero + Search -->
<div class="row mb-4 homepage-hero">
    <div class="col-12">
        <div class="hero-card">
            <div class="row g-4 align-items-center">
                <div class="col-lg-6">
                    <span class="eyebrow">Nepal’s doctor directory built on verified profiles and feedback</span>
                    <h1 class="display-5 fw-bold mb-3 text-brand">
                        Find Doctors in Nepal You Can Trust
                    </h1>
                    <p class="lead text-muted mb-4">
                        Search by city and specialty, read patient experiences, and choose with confidence.
                    </p>

                    <div class="trust-strip mb-4">
                        <div class="trust-item">
                            <i class="fas fa-shield-alt me-2 text-brand"></i>NMC License Verification
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-check-circle me-2 text-brand"></i>Document-Reviewed Profiles
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-user-md me-2 text-brand"></i>{{ total_doctors }}+ Doctors
                        </div>
                    </div>

                    <p class="text-muted small mt-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        No account needed to search.
                    </p>
                    <p class="text-muted small mt-1 mb-0">
                        <i class="fas fa-shield-alt me-1"></i>
                        Verified badge = NMC license check + document review (not a medical endorsement).
                    </p>
                </div>

                <div class="col-lg-6">
                    {% set popular = namespace(kathmandu=None, pokhara=None, lalitpur=None, cardiology=None, pediatrics=None, orthopedics=None) %}
                    {% for city in cities %}
                        {% if city.name == 'Kathmandu' %}{% set popular.kathmandu = city.id %}{% endif %}
                        {% if city.name == 'Pokhara' %}{% set popular.pokhara = city.id %}{% endif %}
                        {% if city.name == 'Lalitpur' %}{% set popular.lalitpur = city.id %}{% endif %}
                    {% endfor %}
                    {% for specialty in specialties %}
                        {% if specialty.name == 'Cardiology' %}{% set popular.cardiology = specialty.id %}{% endif %}
                        {% if specialty.name == 'Pediatrics' or specialty.name == 'Paediatrics' %}{% set popular.pediatrics = specialty.id %}{% endif %}
                        {% if specialty.name == 'Orthopedics' or specialty.name == 'Orthopaedics' %}{% set popular.orthopedics = specialty.id %}{% endif %}
                    {% endfor %}
                    <div class="search-container search-card search-card--primary" id="searchSection">
                        <h3 class="text-center">
                            <i class="fas fa-search me-2"></i>Find a Doctor Near You
                        </h3>
                        <p class="text-center text-muted mb-4">Search by name, city, or specialty</p>

                        <form id="filterForm">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="nameSearch" class="form-label">
                                        <i class="fas fa-user-md me-2"></i>Doctor name <span class="text-muted fw-normal">(optional)</span>
                                    </label>
                                    <input type="text" id="nameSearch" class="form-control" placeholder="Search by name..." autocomplete="off">
                                </div>
                                <div class="col-md-6">
                                    <label for="citySelect" class="form-label">
                                        <i class="fas fa-map-marker-alt me-2"></i>City
                                    </label>
                                    <select id="citySelect" class="form-select">
                                        <option value="">Any city</option>
                                        {% for city in cities %}
                                        <option value="{{ city.id }}">{{ city.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="specialtySelect" class="form-label">
                                        <i class="fas fa-stethoscope me-2"></i>Specialty
                                    </label>
                                    <select id="specialtySelect" class="form-select">
                                        <option value="">Any specialty</option>
                                        {% for specialty in specialties %}
                                        <option value="{{ specialty.id }}">{{ specialty.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="button" id="filterBtn" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-search me-2"></i>Search Doctors
                                    </button>
                                </div>
                            </div>

                            {% if popular.kathmandu or popular.pokhara or popular.lalitpur %}
                            <div class="popular-searches mt-3">
                                <div class="text-muted small mb-2 text-center">Popular searches</div>
                                <div class="d-flex flex-wrap gap-2 justify-content-center">
                                    {% if popular.kathmandu and popular.cardiology %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary popular-search-chip" data-city="{{ popular.kathmandu }}" data-specialty="{{ popular.cardiology }}">
                                        Kathmandu • Cardiology
                                    </button>
                                    {% endif %}
                                    {% if popular.pokhara and popular.orthopedics %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary popular-search-chip" data-city="{{ popular.pokhara }}" data-specialty="{{ popular.orthopedics }}">
                                        Pokhara • Orthopedics
                                    </button>
                                    {% endif %}
                                    {% if popular.lalitpur and popular.pediatrics %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary popular-search-chip" data-city="{{ popular.lalitpur }}" data-specialty="{{ popular.pediatrics }}">
                                        Lalitpur • Pediatrics
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div><!-- /row -->
        </div><!-- /hero-card -->
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-strip">
            <div class="row text-center g-3">
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-brand">{{ total_doctors }}+</h3>
                    <p class="text-muted mb-0">Doctors listed</p>
                </div>
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-accent">{{ total_cities }}+</h3>
                    <p class="text-muted mb-0">Cities covered</p>
                </div>
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-brand">{{ total_reviews }}+</h3>
                    <p class="text-muted mb-0">Patient reviews</p>
                </div>
                <div class="col-6 col-md-3">
                    <h3 class="fw-bold mb-1 text-accent">{{ verified_doctors }}+</h3>
                    <p class="text-muted mb-0">Verified profiles</p>
                </div>
            </div>

            <div class="text-center mt-3">
                <p class="text-muted small mb-0">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    Kathmandu | Lalitpur | Pokhara | Biratnagar | Birtamod
                </p>
            </div>

            <div class="text-center mt-2">
                <p class="text-muted small mb-0">
                    Doctor info combines public sources and self-submitted updates.
                    <strong>Verified</strong> badges reflect document review (not a medical endorsement).
                </p>
            </div>
        </div>
    </div>
</div>

<div class="section-divider" aria-hidden="true"></div>

<!-- What is RankSewa Section (for SEO and clarity) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-lg-8 mx-auto text-center">
                        <h2 class="h3 fw-bold mb-3 text-brand">What is RankSewa?</h2>
                        <p class="lead text-muted mb-4">
                            Nepal’s healthcare directory with verified credentials and real patient feedback.
                        </p>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="h-100 border rounded-3 p-3 text-start bg-white">
                                    <div class="d-flex align-items-center gap-3 mb-2">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-search text-brand fs-6"></i>
                                        </div>
                                        <h5 class="fw-semibold mb-0">Search with confidence</h5>
                                    </div>
                                    <p class="text-muted small mb-0">Filter by city and specialty to find the right doctor faster.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="h-100 border rounded-3 p-3 text-start bg-white">
                                    <div class="d-flex align-items-center gap-3 mb-2">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-star text-brand fs-6"></i>
                                        </div>
                                        <h5 class="fw-semibold mb-0">Real patient reviews</h5>
                                    </div>
                                    <p class="text-muted small mb-0">Read experiences and ratings to make an informed choice.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="h-100 border rounded-3 p-3 text-start bg-white">
                                    <div class="d-flex align-items-center gap-3 mb-2">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-shield-alt text-brand fs-6"></i>
                                        </div>
                                        <h5 class="fw-semibold mb-0">Verified profiles</h5>
                                    </div>
                                    <p class="text-muted small mb-0">Verified badge = NMC license check + document review (not a medical endorsement).</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-divider" aria-hidden="true"></div>

<div class="row">
    <div class="col-12">
        <!-- Doctor Claim Profile CTA -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm overflow-hidden cta-surface">
                    <div class="card-body p-3 p-lg-4">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <div class="d-inline-flex align-items-center gap-2 bg-white border rounded-pill px-3 py-1 mb-3">
                                    <span class="badge bg-success">ALWAYS FREE</span>
                                    <small class="fw-semibold text-brand">Claim anytime</small>
                                </div>
                                <h4 class="mb-2 text-dark">Doctors: Claim Your Profile in Minutes</h4>
                                <p class="mb-3 text-muted">
                                    Update your details, submit documents for verification, and respond to patient feedback.
                                </p>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="fas fa-check-circle text-success mt-1"></i>
                                            <span class="small">Show verified credentials</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="fas fa-check-circle text-success mt-1"></i>
                                            <span class="small">Build patient trust faster</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="fas fa-check-circle text-success mt-1"></i>
                                            <span class="small">Get verified badge after review (2–3 business days)</span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-muted small mb-0">
                                    Verification review: typically 2–3 business days (may vary).
                                </p>
                            </div>

                            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('claim_profile') }}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-check-circle me-2"></i>Claim Your Profile
                                    </a>
                                    <a href="{{ url_for('doctor_self_register') }}" class="btn btn-outline-primary btn-lg">
                                        <i class="fas fa-user-plus me-2"></i>Register as New Doctor
                                    </a>
                                </div>
                                <div class="mt-3 small text-success fw-semibold">
                                    <i class="fas fa-gift me-1"></i>Always free to claim
                                </div>
                            </div>
                        </div><!-- /row -->
                    </div>
                </div>
            </div>
        </div>

        <!-- How RankSewa Helps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h3 class="text-center mb-4">How RankSewa Helps</h3>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="text-center p-3">
                                    <div class="mb-3">
                                        <i class="fas fa-users fa-3x text-brand"></i>
                                    </div>
                                    <h5 class="mb-3">For Patients</h5>
                                    <ul class="list-unstyled text-start" style="max-width: 340px; margin: 0 auto;">
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Read real patient experiences</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Compare doctors by city & specialty</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Choose with more confidence</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3">
                                    <div class="mb-3">
                                        <i class="fas fa-user-md fa-3x text-accent"></i>
                                    </div>
                                    <h5 class="mb-3">For Doctors</h5>
                                    <ul class="list-unstyled text-start" style="max-width: 340px; margin: 0 auto;">
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Claim profile & correct info</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Show experience, workplace, services</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Respond to feedback professionally</li>
                                    </ul>
                                </div>
                            </div>
                        </div><!-- /row -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Why Reviews Matter -->
        <div class="row mb-4" id="whyReviewsMatter">
            <div class="col-12">
                <div class="card border-0 shadow-sm highlight-surface">
                    <div class="card-body p-4 text-center">
                        <h3 class="mb-3">Why Reviews Matter</h3>
                        <p class="lead text-muted" style="max-width: 860px; margin: 0 auto;">
                            Choosing a doctor is a big decision. RankSewa helps people learn from real experiences so
                            good care gets recognized and patients feel safer.
                        </p>

                        <div class="row g-3 mt-4" style="max-width: 920px; margin: 0 auto;">
                            <div class="col-md-4">
                                <div class="p-3 bg-white border rounded-3 h-100">
                                    <div class="fw-bold mb-1"><i class="fas fa-search me-2 text-brand"></i>1) Search</div>
                                    <div class="text-muted small">Find the doctor by name, city, or specialty.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-white border rounded-3 h-100">
                                    <div class="fw-bold mb-1"><i class="fas fa-id-card me-2 text-brand"></i>2) Open profile</div>
                                    <div class="text-muted small">View details, clinic, and existing reviews.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-white border rounded-3 h-100">
                                    <div class="fw-bold mb-1"><i class="fas fa-pen me-2 text-brand"></i>3) Share experience</div>
                                    <div class="text-muted small">Leave a respectful review to help others.</div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <a href="#searchSection" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>Search & Review
                            </a>
                        </div>

                        <p class="text-muted small mt-3 mb-0">
                            <i class="fas fa-shield-alt me-1"></i>
                            RankSewa does not provide medical advice. For emergencies, contact local services immediately.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-divider" aria-hidden="true"></div>

        <!-- Results -->
        <div class="row" id="resultsSection">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
                    <h2 class="mb-0">
                        <i class="fas fa-list me-2"></i><span id="resultsTitle">Doctor List</span>
                    </h2>
                    <span id="resultsCount" class="badge bg-primary" style="display: none;"></span>
                </div>
                <p class="text-muted mb-3 small">Verified profiles are highlighted so you can choose with confidence.</p>

                <div id="doctorList" class="row">
                    <div class="col-12 text-center py-5">
                        <p class="mt-2">Please use the search filters to find doctors</p>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /col -->
</div><!-- /row -->

<!-- Floating Back to Search Button -->
<button id="backToSearchBtn" class="back-to-search-btn" onclick="scrollToSearch()" title="Back to search">
    <i class="fas fa-search me-2"></i>New Search
</button>

<style>
.back-to-search-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: linear-gradient(135deg, var(--brand) 0%, var(--accent) 100%);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 14px 24px;
    font-weight: 700;
    font-size: 0.95rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    pointer-events: none;
}

.back-to-search-btn.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

.back-to-search-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
}

/* Tablet */
@media (max-width: 768px) {
    .back-to-search-btn {
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
    }
}

/* Mobile - optimized for 70% mobile users */
@media (max-width: 576px) {
    .back-to-search-btn {
        /* Safe area for notched phones (iPhone X+) */
        bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        right: 16px;
        left: 16px;
        /* Full width button for easier thumb tap */
        width: calc(100% - 32px);
        padding: 14px 20px;
        font-size: 0.9rem;
        text-align: center;
        /* Minimum touch target size (48px recommended by Google) */
        min-height: 48px;
        /* Slide up from bottom animation */
        transform: translateY(100px);
    }

    .back-to-search-btn.visible {
        transform: translateY(0);
    }

    .back-to-search-btn:hover {
        /* Disable hover effects on touch devices */
        transform: translateY(0);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .back-to-search-btn:active {
        /* Touch feedback */
        transform: scale(0.98);
        opacity: 0.9;
    }
}
</style>

<script>
// Show/hide floating search button based on scroll position
function handleScrollButton() {
    const searchSection = document.getElementById('searchSection');
    const backBtn = document.getElementById('backToSearchBtn');

    if (!searchSection || !backBtn) return;

    const searchBottom = searchSection.getBoundingClientRect().bottom;

    // Show button when search section is scrolled out of view
    if (searchBottom < 0) {
        backBtn.classList.add('visible');
    } else {
        backBtn.classList.remove('visible');
    }
}

function scrollToSearch() {
    const searchSection = document.getElementById('searchSection');
    if (searchSection) {
        searchSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Focus the name search input after scrolling
        setTimeout(() => {
            document.getElementById('nameSearch')?.focus();
        }, 500);
    }
}

// Throttle scroll event using requestAnimationFrame for smooth performance
let scrollTicking = false;
window.addEventListener('scroll', function() {
    if (!scrollTicking) {
        requestAnimationFrame(function() {
            handleScrollButton();
            scrollTicking = false;
        });
        scrollTicking = true;
    }
}, { passive: true });

// Initial check
document.addEventListener('DOMContentLoaded', handleScrollButton);
</script>
{% endblock %}

{% block scripts %}
<!-- Select2 CSS (for searchable dropdowns) -->
<link href="{{ url_for('static', filename='vendor/select2/select2.min.css') }}" rel="stylesheet" />
<link href="{{ url_for('static', filename='vendor/select2/select2-bootstrap-5-theme.min.css') }}" rel="stylesheet" />

<!-- Select2 JS -->
<script src="{{ url_for('static', filename='vendor/select2/select2.min.js') }}"></script>

<script>
$(document).ready(function() {
    let suppressAutoLoad = false;

    // Initialize Select2 on city and specialty dropdowns for better UX with 1000+ cities
    $('#citySelect').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search cities...',
        allowClear: true,
        width: '100%'
    });

    $('#specialtySelect').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search specialties...',
        allowClear: true,
        width: '100%'
    });

    $('.popular-search-chip').on('click', function() {
        const cityId = $(this).data('city');
        const specialtyId = $(this).data('specialty');

        suppressAutoLoad = true;

        if (cityId) {
            $('#citySelect').val(String(cityId)).trigger('change');
        } else {
            $('#citySelect').val(null).trigger('change');
        }

        if (specialtyId) {
            $('#specialtySelect').val(String(specialtyId)).trigger('change');
        } else {
            $('#specialtySelect').val(null).trigger('change');
        }

        $('#nameSearch').val('');

        suppressAutoLoad = false;
        loadDoctors(1, true);
    });

    // Handle URL parameters (e.g., ?city=1&specialty=2)
    const urlParams = new URLSearchParams(window.location.search);
    const cityParam = urlParams.get('city');
    const specialtyParam = urlParams.get('specialty');

    if (cityParam) {
        $('#citySelect').val(cityParam).trigger('change');
    }
    if (specialtyParam) {
        $('#specialtySelect').val(specialtyParam).trigger('change');
    }

    loadDoctors(); // Initial load - no scroll

    $('#filterBtn').click(function() {
        loadDoctors(1, true); // User clicked search - scroll to results
    });

    // Use Select2 change event instead of regular change
    $('#citySelect, #specialtySelect').on('select2:select select2:clear', function() {
        if (suppressAutoLoad) {
            return;
        }
        loadDoctors(1, false); // Update results without auto-scroll
    });

    // Search as user types (with debounce)
    let searchTimeout;
    $('#nameSearch').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadDoctors(1, false); // Update results without auto-scroll
        }, 500);
    });

    // Prevent form submission when pressing Enter
    $('#filterForm').on('submit', function(e) {
        e.preventDefault(); // Stop form from submitting
        loadDoctors(1, true); // Trigger search and scroll to results
        return false;
    });

    // Also handle Enter key specifically in name search field
    $('#nameSearch').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            clearTimeout(searchTimeout); // Cancel debounce timer
            loadDoctors(1, true); // Immediate search and scroll
            return false;
        }
    });
});

let currentPage = 1;
let shouldScroll = false; // Track if we should scroll after loading doctors

function scrollToResults() {
    if (!shouldScroll) {
        return;
    }

    setTimeout(function() {
        const target = $("#resultsSection");
        if (!target.length) {
            return;
        }

        $('html, body').animate({
            scrollTop: target.offset().top - 100
        }, 600, 'swing');
    }, 100);
}

function loadDoctors(page = 1, scroll = false) {
    const cityId = $('#citySelect').val();
    const specialtyId = $('#specialtySelect').val();
    const nameSearch = $('#nameSearch').val();
    currentPage = page;
    shouldScroll = scroll;

    $('#doctorList').html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status" aria-label="Loading"></div></div>');

    $.ajax({
        url: '/doctors',
        type: 'GET',
        data: {
            city_id: cityId,
            specialty_id: specialtyId,
            name: nameSearch,
            page: page
        },
        success: function(response) {
            lastDoctorsResponse = response;
            displayDoctors(response);
        },
        error: function() {
            $('#doctorList').html('<div class="col-12"><div class="alert alert-danger">Error loading doctors.</div></div>');
        }
    });
}

let lastDoctorsResponse = null;
const isAdmin = {{ 'true' if session.get('is_admin') else 'false' }};
const currentUserRole = {{ (session.get('role') or '')|tojson }};

// Generate professional avatar URL for doctors without photos
function getDoctorAvatar(doctorName, doctorId) {
        let cleanedName = doctorName || '';
        const titleRegex = /^\s*(dr|mr|mrs|ms|prof|professor|asst|assistant|assoc|associate)\.?\s+/i;
        while (titleRegex.test(cleanedName)) {
            cleanedName = cleanedName.replace(titleRegex, '');
        }
        cleanedName = cleanedName.trim() || doctorName;
    const colors = ['0D8ABC', '2a9d8f', 'e76f51', 'f4a261', '264653', '9b59b6', '3498db', '16a085'];
    const color = colors[doctorId % colors.length];
    const seed = encodeURIComponent(cleanedName);
    return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}&backgroundColor=${color}`;
}

function normalizeDoctorDescription(description) {
    if (!description) {
        return '';
    }

    const temp = document.createElement('div');
    temp.innerHTML = String(description);
    return (temp.textContent || temp.innerText || '').replace(/\s+/g, ' ').trim();
}

function displayDoctors(response, shouldScroll = true) {
    const doctors = response.doctors || response; // Handle both old and new format
    const pagination = response.pagination;

    // Update results title and count
    if (pagination && pagination.total_doctors > 0) {
        $('#resultsTitle').text('Search Results');
        $('#resultsCount').text(`${pagination.total_doctors} ${pagination.total_doctors === 1 ? 'doctor' : 'doctors'} found`).show();
    } else {
        $('#resultsTitle').text('Doctor List');
        $('#resultsCount').hide();
    }

    if (!doctors || doctors.length === 0) {
        $('#doctorList').html('<div class="col-12"><div class="alert alert-info">No doctors found matching your search.</div></div>');
        $('#resultsCount').hide();
        if (shouldScroll) {
            scrollToResults();
        }
        return;
    }

    let html = '';
    doctors.forEach((doctor, index) => {
        const ratingCount = doctor.rating_count || 0;
        const hasRatings = ratingCount > 0;
        const avgRating = hasRatings ? parseFloat(doctor.avg_rating).toFixed(1) : '0.0';
        const starTextHtml = generateStarTextHtml(doctor.avg_rating, ratingCount);

        const adminEditButton = isAdmin
            ? `<a href="/admin/doctors/${doctor.id}/edit" class="btn btn-outline-secondary btn-sm btn-admin-edit">Edit</a>`
            : '';

        const cityName = (doctor.city_name || '').replace(/\s+/g, ' ').trim();
        const cityLabel = cityName || 'Not specified';
        const specialtyName = doctor.specialty_name || 'General Practice';
        const experienceLabel = doctor.experience && doctor.experience > 0 ? `${doctor.experience} Years` : 'N/A';
        const practiceLabel = formatPracticeLocations(doctor.clinic_name || doctor.workplace || 'Not specified');

        const imgSrc = doctor.photo_url || getDoctorAvatar(doctor.name, doctor.id);

        // Verified badge HTML (v2 avatar)
        const verifiedBadgeHtmlV2 = doctor.is_verified
            ? `<div class="badge-verified-v2"><i class="fas fa-check"></i></div>`
            : '';

        // Rating pill classes
        const ratingPillClass = hasRatings ? 'rating-pill-v2' : 'rating-pill-v2 no-rating';
        const emptyStarsHtml = '<i class="far fa-star"></i>'.repeat(5);
        const ratingDisplay = hasRatings
            ? `<span class="stars-v2">${starTextHtml}</span><span class="rating-score-v2">${avgRating}</span><span class="rating-count-v2">(${ratingCount})</span>`
            : `<span class="stars-v2">${emptyStarsHtml}</span><span class="rating-count-v2">No reviews yet</span>`;

        // Featured badge - now inline with name
        const featuredBadgeHtml = doctor.is_featured
            ? `<span class="badge-featured-v2">Featured</span>`
            : '';
        const verifiedBadgeHtmlSimple = doctor.is_verified
            ? '<span class="badge bg-success" style="font-size: 0.65rem; padding: 3px 8px;">✓ Verified</span>'
            : '';

        // Claim link for unclaimed profiles - with view count for social proof
        const showClaimPrompt = !doctor.is_claimed && !doctor.is_verified && currentUserRole !== 'doctor' && !isAdmin;
        const viewCount = doctor.profile_views || 0;
        const viewsText = viewCount >= 10 ? `<div class="claim-views"><i class="fas fa-eye"></i> ${viewCount} views</div>` : '';
        const unclaimedPillHtml = showClaimPrompt
            ? '<span class="badge bg-light text-dark border ms-2" style="font-size: 0.62rem; padding: 2px 6px;">Unclaimed</span>'
            : '';
        const claimHintHtml = showClaimPrompt
            ? '<div class="text-muted small">Claim free to update info + respond to reviews.</div>'
            : '';
        // Always render footer-extra div for consistent card heights
        // Unclaimed: shows views + claim link
        // Claimed/verified: shows view count if >= 10, otherwise empty spacer
        const claimLinkHtml = showClaimPrompt
            ? `<div class="card-footer-extra">${viewsText}<a href="/claim-profile/${doctor.id}" class="claim-link claim-link-pill"><i class="fas fa-bolt"></i>Is this you? Claim your profile</a></div>`
            : `<div class="card-footer-extra">${viewsText}</div>`;
        const claimButton = '';

        // Description text (sanitized and truncated)
        const descriptionText = normalizeDoctorDescription(doctor.description);
        const descriptionLine = descriptionText || `Specialist in ${specialtyName} • ${cityLabel}`;

        const cardHtml = `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card doctor-card h-100 ${doctor.is_featured ? 'featured' : ''} ${doctor.is_verified ? 'verified' : ''}">
                    <div class="card-body">
                        <div class="doctor-header">
                            <div class="doctor-identity">
                                <div class="doctor-avatar">
                                    <img
                                        src="${imgSrc}"
                                        data-name="${String(doctor.name || '')}"
                                        data-id="${doctor.id}"
                                        class="rounded-circle"
                                        alt="${doctor.name}"
                                        width="80"
                                        height="80"
                                        loading="${index < 6 ? 'eager' : 'lazy'}"
                                        decoding="async"
                                        onerror="this.onerror=null; this.src=getDoctorAvatar(this.dataset.name, parseInt(this.dataset.id || '0', 10));"
                                    >
                                </div>
                                <div class="doctor-title">
                                    <div class="doctor-name">${doctor.name}${unclaimedPillHtml}</div>
                                    <div class="doctor-subtitle">
                                        <i class="fas fa-stethoscope"></i>
                                        <span>${specialtyName}</span>
                                    </div>
                                    <div class="doctor-location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${cityLabel}</span>
                                    </div>
                                    ${claimHintHtml}
                                </div>
                            </div>
                            <div class="doctor-badges">
                                ${verifiedBadgeHtmlSimple}
                            </div>
                        </div>

                        <div class="doctor-rating-section">
                            <span class="rating-display rating-display-inline">${ratingDisplay}</span>
                        </div>

                        <div class="doctor-info-lines">
                            <div class="info-line"><strong>Experience:</strong> ${experienceLabel}</div>
                            <div class="info-line"><strong>Practice:</strong> ${practiceLabel}</div>
                        </div>

                        ${descriptionLine ? `<p class="doctor-summary">${descriptionLine}</p>` : ''}

                        <div class="card-footer-section">
                            <div class="doctor-actions">
                                <a href="/doctor/${doctor.slug}" class="btn btn-view-doctor btn-sm">
                                    View Profile
                                </a>
                                ${adminEditButton}
                            </div>
                            ${claimLinkHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;

        html += cardHtml;
    });

    $('#doctorList').html(html);

    // Add pagination if available
    if (pagination && pagination.total_pages > 1) {
        let paginationHtml = '<div class="col-12"><nav aria-label="Doctor results pagination"><ul class="pagination justify-content-center mt-4">';

        // Previous button
        if (pagination.has_prev) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${pagination.page - 1}, true); return false;">Previous</a></li>`;
        } else {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">Previous</span></li>';
        }

        // Page numbers (show max 5 pages at a time)
        let startPage = Math.max(1, pagination.page - 2);
        let endPage = Math.min(pagination.total_pages, pagination.page + 2);

        if (startPage > 1) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(1, true); return false;">1</a></li>`;
            if (startPage > 2) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            if (i === pagination.page) {
                paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${i}, true); return false;">${i}</a></li>`;
            }
        }

        if (endPage < pagination.total_pages) {
            if (endPage < pagination.total_pages - 1) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${pagination.total_pages}, true); return false;">${pagination.total_pages}</a></li>`;
        }

        // Next button
        if (pagination.has_next) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadDoctors(${pagination.page + 1}, true); return false;">Next</a></li>`;
        } else {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">Next</span></li>';
        }

        paginationHtml += '</ul></nav>';
        paginationHtml += `<p class="text-center text-muted small">Showing page ${pagination.page} of ${pagination.total_pages} (${pagination.total_doctors} doctors total)</p>`;
        paginationHtml += '</div>';

        $('#doctorList').append(paginationHtml);

    }

    // Only scroll to results if user actively searched/filtered/paginated (not on initial load)
    if (shouldScroll) {
        scrollToResults();
    }
}


// Format practice locations - show first location + "and X more" if multiple
function formatPracticeLocations(practice) {
    if (!practice || practice === 'Not specified') return practice;

    // Split by common separators (periods, commas followed by space and capital, or explicit "and")
    // Handle patterns like "Clinic A, City. Clinic B, City"
    const locations = practice.split(/(?:\.\s+|\s*,\s+(?=[A-Z])|\s+and\s+)/i)
        .map(s => s.trim())
        .filter(s => s.length > 2);

    if (locations.length <= 1) {
        // Single location - truncate if too long
        return practice.length > 50 ? practice.substring(0, 47) + '...' : practice;
    }

    // Multiple locations - show first + count
    const firstLocation = locations[0].length > 35
        ? locations[0].substring(0, 32) + '...'
        : locations[0];
    const moreCount = locations.length - 1;
    return `${firstLocation} <span class="text-muted small">+${moreCount} more</span>`;
}

function generateStarRatingHtml(rating, ratingCount) {
    let html = '';
    const numericRating = ratingCount ? parseFloat(rating) : 0;
    const fullStars = Math.floor(numericRating);
    const hasHalfStar = ratingCount && (numericRating - fullStars) >= 0.5;

    for (let i = 0; i < fullStars; i++) {
        html += '<i class="fas fa-star text-warning"></i>';
    }

    if (hasHalfStar) {
        html += '<i class="fas fa-star-half-alt text-warning"></i>';
    }

    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < emptyStars; i++) {
        html += '<i class="far fa-star text-muted"></i>';
    }

    return html;
}

// Generate small Font Awesome star rating
function generateStarTextHtml(rating, ratingCount) {
    const numericRating = ratingCount ? parseFloat(rating) : 0;
    const fullStars = Math.floor(numericRating);
    const hasHalfStar = ratingCount && (numericRating - fullStars) >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    let html = '';
    for (let i = 0; i < fullStars; i++) {
        html += '<i class="fas fa-star"></i>';
    }
    if (hasHalfStar) {
        html += '<i class="fas fa-star-half-alt"></i>';
    }
    for (let i = 0; i < emptyStars; i++) {
        html += '<i class="far fa-star"></i>';
    }
    return html;
}
</script>

<!-- Structured Data (JSON-LD) for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "{{ request.url_root }}#organization",
      "name": "RankSewa",
      "url": "{{ request.url_root }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ request.url_root }}static/img/logo.png",
        "width": 512,
        "height": 512
      },
      "description": "Nepal's premier healthcare directory platform helping patients find and review doctors based on real experiences. Compare doctors by specialty, city, and patient ratings.",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "NP",
        "addressRegion": "Bagmati",
        "addressLocality": "Kathmandu"
      },
      "areaServed": {
        "@type": "Country",
        "name": "Nepal"
      },
      "sameAs": [
        "https://www.facebook.com/ranksewa",
        "https://twitter.com/ranksewa",
        "https://www.linkedin.com/company/ranksewa",
        "https://www.instagram.com/ranksewa"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "{{ request.url_root }}#website",
      "url": "{{ request.url_root }}",
      "name": "RankSewa - Find Doctors in Nepal",
      "description": "Find and review doctors in Nepal based on patient experiences. Search by specialty, city, and read verified patient reviews.",
      "publisher": {
        "@id": "{{ request.url_root }}#organization"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "{{ request.url_root }}doctors?name={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      },
      "inLanguage": "en-US"
    },
    {
      "@type": "WebPage",
      "@id": "{{ request.url }}#webpage",
      "url": "{{ request.url }}",
      "name": "RankSewa - Find Doctors in Nepal Based on Patient Reviews",
      "isPartOf": {
        "@id": "{{ request.url_root }}#website"
      },
      "about": {
        "@id": "{{ request.url_root }}#organization"
      },
      "description": "Discover and compare {{ total_doctors }}+ doctors in Nepal. Search by specialty and city, verify NMC credentials, and find trusted healthcare providers.",
      "inLanguage": "en-US"
    },
    {
      "@type": "MedicalOrganization",
      "name": "RankSewa Healthcare Directory",
      "url": "{{ request.url_root }}",
      "description": "Comprehensive healthcare directory for Nepal featuring {{ total_doctors }}+ doctors across {{ total_cities }}+ cities with {{ total_reviews }}+ patient reviews",
      "medicalSpecialty": [
        "Cardiology", "Dermatology", "Pediatrics", "Orthopedics", "Gynecology",
        "Neurology", "Ophthalmology", "ENT", "General Medicine", "Dentistry"
      ]
    }
  ]
}
</script>
{% endblock %}
