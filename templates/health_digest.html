{% extends "base.html" %}

{% block title %}The Nepal Health Journal - RankSewa{% endblock %}

{% block head %}
<style>
@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="journal-container">
    <!-- Journal Masthead -->
    <header class="journal-masthead">
        <div class="journal-masthead-inner">
            <div class="journal-title">
                <span class="journal-the">The</span>
                <span class="journal-name">Nepal Health Journal</span>
            </div>
            <p class="journal-tagline">Nepal's trusted source for health insights</p>
        </div>
    </header>

    <!-- Category Navigation -->
    <nav class="journal-nav">
        <a href="{{ url_for('health_digest') }}" class="journal-nav-link {% if not current_category %}active{% endif %}">All</a>
        {% for cat in categories %}
        <a href="{{ url_for('health_digest', category=cat.slug) }}"
           class="journal-nav-link {% if current_category and current_category.slug == cat.slug %}active{% endif %}">
            {{ cat.name }}
        </a>
        {% endfor %}
    </nav>

    {% if articles %}
    <!-- Newspaper Layout -->
    <div class="journal-layout">
        <!-- Main Content Area -->
        <div class="journal-main">
            <!-- Lead Story -->
            {% set featured = articles|selectattr('is_featured')|first or articles[0] %}
            <article class="journal-lead">
                <a href="{{ url_for('article_detail', slug=featured.slug) }}" class="journal-lead-image">
                    {% if featured.featured_image %}
                        {% if featured.featured_image.startswith('/static/') or featured.featured_image.startswith('http') %}
                            <img src="{{ featured.featured_image }}"
                        {% else %}
                            <img src="{{ url_for('static', filename='img/' + featured.featured_image) }}"
                        {% endif %}
                    {% else %}
                        <img src="https://picsum.photos/seed/article{{ featured.id }}/800/450"
                    {% endif %}
                         alt="{{ featured.title }}"
                         loading="eager">
                </a>
                <div class="journal-lead-content">
                    <span class="journal-category">{{ featured.category.name }}</span>
                    <h1 class="journal-lead-title">
                        <a href="{{ url_for('article_detail', slug=featured.slug) }}">{{ featured.title }}</a>
                    </h1>
                    <p class="journal-lead-excerpt">{{ featured.summary or (featured.content[:250] + '...') }}</p>
                    <div class="journal-byline">
                        By <strong>{{ featured.author_name }}</strong> &bull; {{ featured.published_at.strftime('%B %d, %Y') if featured.published_at else featured.created_at.strftime('%B %d, %Y') }}
                    </div>
                </div>
            </article>

            <!-- Secondary Stories (2-column newspaper style) -->
            {% set remaining_articles = articles|rejectattr('id', 'equalto', featured.id)|list %}
            {% if remaining_articles %}
            <div class="journal-columns">
                {% for article in remaining_articles[:6] %}
                <article class="journal-story {% if loop.index <= 2 %}journal-story--with-image{% endif %}">
                    {% if loop.index <= 2 %}
                    <a href="{{ url_for('article_detail', slug=article.slug) }}" class="journal-story-image">
                        {% if article.featured_image %}
                            {% if article.featured_image.startswith('/static/') or article.featured_image.startswith('http') %}
                                <img src="{{ article.featured_image }}"
                            {% else %}
                                <img src="{{ url_for('static', filename='img/' + article.featured_image) }}"
                            {% endif %}
                        {% else %}
                            <img src="https://picsum.photos/seed/article{{ article.id }}/400/250"
                        {% endif %}
                             alt="{{ article.title }}"
                             loading="lazy">
                    </a>
                    {% endif %}
                    <div class="journal-story-content">
                        <span class="journal-category-sm">{{ article.category.name }}</span>
                        <h3 class="journal-story-title">
                            <a href="{{ url_for('article_detail', slug=article.slug) }}">{{ article.title }}</a>
                        </h3>
                        <p class="journal-story-excerpt">{{ article.summary or (article.content[:100] + '...') }}</p>
                        <span class="journal-story-meta">{{ article.author_name }} &bull; {{ article.published_at.strftime('%b %d') if article.published_at else article.created_at.strftime('%b %d') }}</span>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% endif %}

            <!-- More Stories (compact list) -->
            {% if remaining_articles|length > 6 %}
            <div class="journal-more">
                <h4 class="journal-section-title">More Stories</h4>
                <div class="journal-headlines">
                    {% for article in remaining_articles[6:] %}
                    <article class="journal-headline">
                        <span class="journal-category-xs">{{ article.category.name }}</span>
                        <h4 class="journal-headline-title">
                            <a href="{{ url_for('article_detail', slug=article.slug) }}">{{ article.title }}</a>
                        </h4>
                        <span class="journal-headline-meta">{{ article.author_name }} &bull; {{ article.read_time }} min</span>
                    </article>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <aside class="journal-sidebar">
            <!-- Search -->
            <div class="journal-widget">
                <form action="{{ url_for('health_digest') }}" method="GET" class="journal-search">
                    {% if current_category %}
                    <input type="hidden" name="category" value="{{ current_category.slug }}">
                    {% endif %}
                    <input type="text" name="q" placeholder="Search..." value="{{ search_query or '' }}" class="journal-search-input">
                    <button type="submit" class="journal-search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>

            <!-- Categories -->
            <div class="journal-widget">
                <h4 class="journal-widget-heading">Sections</h4>
                <ul class="journal-sections">
                    <li>
                        <a href="{{ url_for('health_digest') }}" class="{% if not current_category %}active{% endif %}">
                            All <span>{{ categories|map(attribute='articles')|map('length')|sum }}</span>
                        </a>
                    </li>
                    {% for cat in categories %}
                    <li>
                        <a href="{{ url_for('health_digest', category=cat.slug) }}"
                           class="{% if current_category and current_category.slug == cat.slug %}active{% endif %}">
                            {{ cat.name }} <span>{{ cat.articles|length }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Editor's Picks -->
            {% if featured_articles %}
            <div class="journal-widget">
                <h4 class="journal-widget-heading">Editor's Picks</h4>
                <ol class="journal-picks">
                    {% for article in featured_articles[:5] %}
                    <li>
                        <a href="{{ url_for('article_detail', slug=article.slug) }}">
                            {{ article.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}

            <!-- CTA -->
            <div class="journal-widget journal-widget--cta">
                <i class="fas fa-stethoscope"></i>
                <h4>Find a Doctor</h4>
                <p>Connect with verified specialists across Nepal</p>
                <a href="{{ url_for('index') }}" class="journal-cta-btn">Search Doctors</a>
            </div>
        </aside>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
        <h4>No Articles Found</h4>
        <p class="text-muted">
            {% if search_query %}
                No articles match your search "{{ search_query }}"
            {% else %}
                Check back soon for new health articles!
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
