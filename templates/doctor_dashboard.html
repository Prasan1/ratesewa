{% extends "base.html" %}

{% block title %}Doctor Dashboard - RankSewa{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');

    /* ---------- Design Tokens ---------- */
    :root{
        --surface: #ffffff;
        --surface-2: #f7fafc;
        --text: #0f172a;
        --muted: #64748b;
        --border: rgba(15, 23, 42, .08);
        --shadow: 0 10px 30px rgba(2, 6, 23, .08);
        --shadow-hover: 0 14px 40px rgba(2, 6, 23, .14);
        --radius-xl: 22px;
        --radius-lg: 16px;
        --radius-md: 12px;
    }

    /* ---------- Layout polish ---------- */
    .dash-wrap {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background: radial-gradient(1200px 400px at 20% -10%, rgba(13,138,188,.12), transparent 60%),
                    radial-gradient(900px 420px at 90% 0%, rgba(123,44,191,.10), transparent 55%),
                    linear-gradient(180deg, #ffffff 0%, #fbfdff 30%, #ffffff 100%);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin: 20px 0;
    }
    @media (max-width: 768px){
        .dash-wrap{
            padding: 16px;
            margin: 12px 0;
            border-radius: 16px;
        }
    }

    @media (max-width: 768px){
        .profile-hero { padding: 1.25rem; }
        .profile-hero .row { gap: 0; }
    }

    /* Tablet and small desktop */
    @media (min-width: 577px) and (max-width: 991px){
        .profile-hero { padding: 1.5rem; }
    }

    @media (max-width: 576px){
        .profile-hero { padding: 1rem !important; }
        .profile-hero .me-4 { margin-right: 0.8rem !important; }
        .profile-hero h1 { font-size: 1.3rem; line-height: 1.3; margin-bottom: 0.4rem !important; }
        .profile-hero p { font-size: 0.9rem !important; margin-bottom: 0.4rem !important; }
        .profile-hero .profile-avatar img,
        .profile-hero .profile-avatar .avatar-fallback {
            width: 60px !important;
            height: 60px !important;
        }
        .profile-hero .fas.fa-user-md { font-size: 1.7rem !important; }
        .verified-badge {
            padding: 0.3rem 0.6rem;
            font-size: 0.72rem;
            gap: 0.25rem;
        }
        .verified-badge i { font-size: 0.7rem; }
        .pill {
            padding: 0.25rem 0.5rem;
            font-size: 0.72rem;
        }
        .quick-stat {
            padding: 0.6rem 0.7rem;
            gap: 0.6rem;
            flex-direction: row;
            align-items: center;
        }
        .quick-stat i { font-size: 1.2rem !important; margin: 0; }
        .quick-stat small { font-size: 0.65rem; display: block; margin-bottom: 0.1rem; }
        .quick-stat strong { font-size: 0.8rem; line-height: 1.2; }
        .quick-stat div { flex: 1; min-width: 0; }
        .btn-lg { padding: 0.5rem 0.8rem; font-size: 0.9rem; }
    }

    /* Extra small phones (iPhone SE, smaller devices) */
    @media (max-width: 400px){
        .profile-hero h1 { font-size: 1.2rem !important; }
        .profile-hero .profile-avatar img,
        .profile-hero .profile-avatar .avatar-fallback {
            width: 56px !important;
            height: 56px !important;
        }
        .verified-badge, .pill { font-size: 0.68rem; padding: 0.25rem 0.5rem; }
    }

    .section-title-row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin: 8px 0 14px;
    }
    .section-title-row h4, .section-title-row h5{
        margin:0;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -.2px;
    }
    .section-sub{
        color: var(--muted);
        font-size: .95rem;
        margin-top: 4px;
    }

    .dash-divider {
        position: relative;
        height: 22px;
        margin: 14px 0 24px;
    }
    .dash-divider::before {
        content: "";
        position: absolute;
        left: 8%;
        right: 8%;
        top: 50%;
        height: 1px;
        background: rgba(15, 23, 42, 0.08);
        transform: translateY(-50%);
    }
    .dash-divider::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(13, 138, 188, 0), rgba(13, 138, 188, 0.08), rgba(13, 138, 188, 0));
        opacity: 0.6;
    }

    /* ---------- Cards ---------- */
    .card-clean{
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        background: var(--surface);
        box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    .card-clean:hover{
        box-shadow: var(--shadow);
    }

    .stat-card {
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: 18px;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        overflow: hidden;
        position: relative;
    }
    .stat-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--shadow-hover) !important;
    }
    .stat-card .card-body { position: relative; z-index: 2; }
    .stat-icon {
        font-size: 3rem;
        opacity: 0.18;
        position: absolute;
        right: 16px;
        bottom: 14px;
        z-index: 1;
    }

    .gradient-purple { background: linear-gradient(135deg, var(--dash-1-start) 0%, var(--dash-1-end) 100%); }
    .gradient-blue   { background: linear-gradient(135deg, var(--dash-2-start) 0%, var(--dash-2-end) 100%); }
    .gradient-orange { background: linear-gradient(135deg, var(--dash-3-start) 0%, var(--dash-3-end) 100%); }
    .gradient-green  { background: linear-gradient(135deg, var(--dash-4-start) 0%, var(--dash-4-end) 100%); }

    .action-card {
        border-radius: 16px;
        transition: all 0.25s ease;
        border: 1px solid var(--border);
        background: var(--surface);
    }
    .action-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow);
        border-color: rgba(13,138,188,.35);
    }
    .action-card--primary {
        border-color: rgba(13,138,188,.45);
        background: rgba(13, 138, 188, 0.06);
        box-shadow: 0 10px 30px rgba(13, 138, 188, 0.12);
    }
    .action-card--secondary {
        background: rgba(255, 255, 255, 0.9);
    }

    .next-step-card {
        border: 1px solid rgba(255,255,255,0.24);
        border-radius: 14px;
        background: rgba(255,255,255,0.16);
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        text-align: left;
        backdrop-filter: blur(10px);
    }
    .next-step-title {
        font-weight: 700;
        font-size: 0.95rem;
        letter-spacing: -0.2px;
    }
    .next-step-meta {
        font-size: 0.82rem;
        opacity: 0.9;
    }

    .today-strip {
        margin-top: 18px;
        background: rgba(255, 255, 255, 0.82);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
    }
    .today-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 140px;
    }
    .today-label {
        font-size: 0.78rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 600;
    }
    .today-value {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--text);
    }
    .today-sub {
        font-size: 0.82rem;
        color: var(--muted);
    }
    .today-action {
        margin-left: auto;
    }
    @media (max-width: 768px) {
        .today-strip {
            gap: 12px;
        }
        .today-item {
            min-width: 120px;
        }
        .today-action {
            width: 100%;
        }
        .today-action .btn {
            width: 100%;
        }
    }

    .soft-hints {
        margin-top: 14px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .soft-hint {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px dashed rgba(15, 23, 42, 0.16);
        background: rgba(255, 255, 255, 0.7);
        color: var(--muted);
        font-size: 0.82rem;
        font-weight: 600;
    }
    .soft-hint i {
        color: var(--brand);
    }

    .zero-review-banner {
        margin-top: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 16px;
        border-radius: 14px;
        border: 1px solid rgba(251, 191, 36, 0.3);
        background: rgba(255, 248, 235, 0.8);
        color: var(--text);
        flex-wrap: wrap;
    }

    .zero-review-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: rgba(251, 191, 36, 0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #b45309;
        flex: 0 0 42px;
    }

    .zero-review-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 0.9rem;
    }

    .zero-review-text span {
        color: var(--muted);
        font-size: 0.85rem;
    }

    .zero-review-action {
        margin-left: auto;
    }

    @media (max-width: 768px) {
        .zero-review-action {
            width: 100%;
        }
        .zero-review-action .btn {
            width: 100%;
        }
    }

    .ranked-checklist {
        padding-left: 1.2rem;
        margin: 0;
    }
    .ranked-checklist li {
        margin: 8px 0;
        display: flex;
        gap: 10px;
        align-items: flex-start;
        color: var(--muted);
    }
    .ranked-checklist li i { margin-top: 3px; }

    /* ---------- Hero ---------- */
    .profile-hero {
        background: linear-gradient(135deg, var(--dash-1-start) 0%, var(--dash-1-end) 100%);
        border-radius: var(--radius-xl);
        padding: 2rem;
        color: white;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow);
    }
    .profile-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.11) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }

    .verified-badge {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        background: rgba(255,255,255,0.22);
        padding: .45rem .9rem;
        border-radius: 999px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.18);
    }

    .quick-stat {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255,255,255,0.14);
        border-radius: 14px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.14);
    }

    /* ---------- Trust / Privacy banner ---------- */
    .privacy-banner{
        border-radius: 16px;
        border: 1px solid rgba(13,138,188,.20);
        background: linear-gradient(135deg, rgba(13,138,188,.08) 0%, rgba(123,44,191,.06) 100%);
        padding: 14px 16px;
        display:flex;
        align-items:flex-start;
        gap:12px;
    }
    .privacy-banner i{ margin-top: 3px; }
    .privacy-banner strong{ color: var(--text); }
    .privacy-banner .small{ color: var(--muted); }

    /* ---------- Profile strength ---------- */
    .progress-wrap{
        background: #eef2ff;
        border-radius: 999px;
        height: 12px;
        overflow: hidden;
        border: 1px solid rgba(15,23,42,.06);
    }
    .progress-bar-custom{
        height: 12px;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(13,138,188,1) 0%, rgba(123,44,191,1) 100%);
        width: 0%;
    }
    .checklist li{
        margin: 8px 0;
        display:flex;
        gap:10px;
        align-items:flex-start;
        color: var(--muted);
    }
    .checklist li i{ margin-top: 3px; }
    .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        border-radius: 999px;
        padding: .35rem .7rem;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.75);
        color: var(--text);
        font-size: .85rem;
    }
</style>

<div class="container">
    <div class="dash-wrap">
        {% set ns = namespace(missing=[], done=[]) %}
        {% if has_photo %}{% set _ = ns.done.append({'label':'Add a profile photo'}) %}{% else %}{% set _ = ns.missing.append({'label':'Add a profile photo'}) %}{% endif %}
        {% if has_edu %}{% set _ = ns.done.append({'label':'Add education'}) %}{% else %}{% set _ = ns.missing.append({'label':'Add education'}) %}{% endif %}
        {% if has_address %}{% set _ = ns.done.append({'label':'Add practice address'}) %}{% else %}{% set _ = ns.missing.append({'label':'Add practice address'}) %}{% endif %}
        {% if has_phone %}{% set _ = ns.done.append({'label':'Add phone number'}) %}{% else %}{% set _ = ns.missing.append({'label':'Add phone number'}) %}{% endif %}
        {% if has_college %}{% set _ = ns.done.append({'label':'Add medical college'}) %}{% else %}{% set _ = ns.missing.append({'label':'Add medical college'}) %}{% endif %}
        {% set actions_all = ns.missing + ns.done %}
        {% set completed_actions = ns.done|length %}
        {% set total_actions = 5 %}
        {% set progress_percent = (completed_actions * 100) // total_actions %}

        <!-- Profile Hero -->
        <div class="profile-hero">
            <div class="row align-items-start align-items-md-center position-relative mb-3 mb-md-0" style="z-index: 2;">
                <div class="col-12 col-md-8">
                    <div class="d-flex align-items-start align-items-md-center mb-3 mb-md-0">
                        <div class="me-3 me-md-4 profile-avatar">
                            {% if doctor.photo_url %}
                            {% set photo_path = doctor.photo_url.replace('photos/', '') %}
                            <img src="{{ url_for('serve_photo', filename=photo_path) }}"
                                 alt="{{ doctor.name }}"
                                 style="width: 96px; height: 96px; border-radius: 50%; object-fit: cover; border: 4px solid rgba(255,255,255,.95); box-shadow: 0 8px 26px rgba(0,0,0,0.22);"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-fallback" style="width: 96px; height: 96px; background: rgba(255,255,255,.95); border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 8px 26px rgba(0,0,0,0.22);">
                                <i class="fas fa-user-md text-brand" style="font-size: 2.7rem;"></i>
                            </div>
                            {% else %}
                            <div class="avatar-fallback" style="width: 96px; height: 96px; background: rgba(255,255,255,.95); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 26px rgba(0,0,0,0.22);">
                                <i class="fas fa-user-md text-brand" style="font-size: 2.7rem;"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h1 class="mb-2" style="font-weight: 800; letter-spacing: -.4px;">{{ doctor.name|doctor_title }}</h1>
                            <p class="mb-2" style="font-size: 1.08rem; opacity: 0.92;">
                                <i class="fas fa-stethoscope me-2"></i>{{ doctor.specialty.name }}
                            </p>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="verified-badge">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Verified Doctor</span>
                                </span>
                                <span class="pill">
                                    <i class="fas fa-shield-alt"></i> Private dashboard
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 text-md-end">
                    <a href="{{ url_for('doctor_profile', slug=doctor.slug) }}" target="_blank" class="btn btn-light btn-lg shadow w-100 w-md-auto" style="max-width: 280px;">
                        <i class="fas fa-external-link-alt me-2"></i>View Public Profile
                    </a>
                    {% if ns.missing|length > 0 %}
                    <div class="next-step-card mt-3">
                        <div class="next-step-title">Next best step</div>
                        <div class="next-step-meta">{{ actions_all[0].label }}</div>
                        <a href="{{ url_for('doctor_profile_edit') }}" class="btn btn-light btn-sm fw-semibold">
                            <i class="fas fa-bolt me-2"></i>Do this now
                        </a>
                    </div>
                    {% else %}
                    <div class="next-step-card mt-3">
                        <div class="next-step-title">You are all set</div>
                        <div class="next-step-meta">Share your public profile to get more visibility.</div>
                        <a href="{{ url_for('doctor_profile', slug=doctor.slug) }}" target="_blank" class="btn btn-light btn-sm fw-semibold">
                            <i class="fas fa-share-alt me-2"></i>Share profile
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Stats row -->
            <div class="row position-relative mt-3 mt-md-4 g-2 g-md-3" style="z-index: 2;">
                <div class="col-6 col-lg-3">
                    <div class="quick-stat">
                        <i class="fas fa-map-marker-alt fa-2x"></i>
                        <div>
                            <small style="opacity: 0.82;">Location</small>
                            <div><strong>{{ doctor.city.name }}</strong></div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="quick-stat">
                        <i class="fas fa-graduation-cap fa-2x"></i>
                        <div>
                            <small style="opacity: 0.82;">Experience</small>
                            <div><strong>{{ doctor.experience or 0 }} Years</strong></div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="quick-stat">
                        <i class="fas fa-certificate fa-2x"></i>
                        <div>
                            <small style="opacity: 0.82;">NMC Number</small>
                            <div><strong>{{ doctor.nmc_number or '-' }}</strong></div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="quick-stat">
                        <i class="fas fa-crown fa-2x"></i>
                        <div>
                            <small style="opacity: 0.82;">Tier</small>
                            <div><strong>{{ doctor.subscription_tier.title() }}</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="today-strip">
            <div class="today-item">
                <div class="today-label">Reviews</div>
                <div class="today-value">{{ review_count }}</div>
                <div class="today-sub">Total so far</div>
            </div>
            <div class="today-item">
                <div class="today-label">Rating</div>
                <div class="today-value">{{ "%.1f"|format(avg_rating) }}/5</div>
                <div class="today-sub">{{ "%.0f"|format(response_rate) }}% response rate</div>
            </div>
            <div class="today-item">
                <div class="today-label">Profile</div>
                <div class="today-value">{{ progress_percent }}% complete</div>
                <div class="today-sub">{{ completed_actions }}/{{ total_actions }} essentials</div>
            </div>
            <div class="today-action">
                {% if ns.missing|length > 0 %}
                <a href="{{ url_for('doctor_profile_edit') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-pen me-2"></i>Complete profile
                </a>
                {% else %}
                <a href="{{ url_for('doctor_profile', slug=doctor.slug) }}" target="_blank" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-share-alt me-2"></i>Share profile
                </a>
                {% endif %}
            </div>
        </div>

        <div class="soft-hints">
            <span class="soft-hint"><i class="fas fa-qrcode"></i>Share your review QR code</span>
            <span class="soft-hint"><i class="fas fa-search"></i>Optimize your profile for search</span>
        </div>

        {% if review_count == 0 %}
        <div class="zero-review-banner">
            <div class="zero-review-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="zero-review-text">
                <strong>First review makes a big difference.</strong>
                <span>Share your QR code with patients to get your first review.</span>
            </div>
            <div class="zero-review-action">
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#qrCodeModal">
                    <i class="fas fa-qrcode me-2"></i>Open QR Code
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Privacy reassurance + value -->
        <div class="mb-4">
            <div class="privacy-banner">
                <i class="fas fa-lock text-primary"></i>
                <div>
                    <div><strong>Your dashboard is private.</strong> Only you can see analytics after login.</div>
                    <div class="small">RankSewa staff (including admins) can only view your public profile—exactly what patients see.</div>
                </div>
            </div>
        </div>

        <!-- Promo banner (unchanged logic) -->
        {% set promo = get_promotion_banner() %}
        {% if promo and doctor.subscription_tier == 'free' %}
        <div class="alert shadow-lg mb-4" style="background: linear-gradient(135deg, {{ promo.color }} 0%, var(--brand) 100%); border: none; border-radius: 16px;">
            <div class="row align-items-center text-white">
                <div class="col-md-8">
                    <h4 class="mb-2"><i class="fas fa-gift me-2"></i>{{ promo.message }}</h4>
                    <p class="mb-0">Get instant access to Premium or Featured tier — FREE for {{ promo.days_left }} days. No credit card required.</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <a href="{{ url_for('subscription_pricing') }}" class="btn btn-light btn-lg shadow">
                        <i class="fas fa-rocket me-2"></i>Claim Free Premium
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="dash-divider" aria-hidden="true"></div>

        <!-- Stats -->
        <div class="section-title-row">
            <div>
                <h4><i class="fas fa-chart-pie me-2 text-primary"></i>Performance Overview</h4>
                <div class="section-sub">A quick snapshot of your visibility and patient feedback.</div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card shadow-sm gradient-purple text-white">
                    <div class="card-body p-4">
                        <i class="fas fa-eye stat-icon"></i>
                        <h6 class="mb-2" style="opacity: 0.92; font-weight: 600;">Profile Views</h6>
                        <h2 class="mb-0" style="font-weight: 800;">{{ "{:,}".format(doctor.profile_views or 0) }}</h2>
                        <small style="opacity: 0.85;">Total impressions</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card shadow-sm gradient-blue text-white">
                    <div class="card-body p-4">
                        <i class="fas fa-star stat-icon"></i>
                        <h6 class="mb-2" style="opacity: 0.92; font-weight: 600;">Total Reviews</h6>
                        <h2 class="mb-0" style="font-weight: 800;">{{ review_count }}</h2>
                        <small style="opacity: 0.85;">Patient feedback</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card shadow-sm gradient-orange text-white">
                    <div class="card-body p-4">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <h6 class="mb-2" style="opacity: 0.92; font-weight: 600;">Average Rating</h6>
                        <h2 class="mb-0" style="font-weight: 800;">
                            {{ "%.1f"|format(avg_rating) }}<small style="font-size: 1.5rem;">/5</small>
                        </h2>
                        <small style="opacity: 0.85;">{% for i in range(avg_rating|int) %}★{% endfor %}</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card shadow-sm gradient-green text-white">
                    <div class="card-body p-4">
                        <i class="fas fa-reply stat-icon"></i>
                        <h6 class="mb-2" style="opacity: 0.92; font-weight: 600;">Response Rate</h6>
                        <h2 class="mb-0" style="font-weight: 800;">{{ "%.0f"|format(response_rate) }}%</h2>
                        <small style="opacity: 0.85;">Reviews responded</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-divider" aria-hidden="true"></div>

        <!-- Quick Actions + Profile Strength -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="section-title-row">
                    <div>
                        <h4><i class="fas fa-bolt me-2 text-primary"></i>Quick Actions</h4>
                        <div class="section-sub">Make your profile stronger in 2–3 minutes.</div>
                    </div>
                </div>
            </div>

            <!-- Profile strength card -->
            {% set has_edu = doctor.education and doctor.education|length > 2 %}
            {% set has_college = doctor.college and doctor.college|length > 2 %}
            {% set has_address = doctor.practice_address and doctor.practice_address|length > 5 %}
            {% set has_phone = doctor.phone_number and doctor.phone_number|length > 5 %}
            {% set has_photo = doctor.photo_url %}
            {% set strength_points = 0 %}
            {% if has_photo %}{% set strength_points = strength_points + 20 %}{% endif %}
            {% if has_edu %}{% set strength_points = strength_points + 20 %}{% endif %}
            {% if has_college %}{% set strength_points = strength_points + 15 %}{% endif %}
            {% if has_address %}{% set strength_points = strength_points + 25 %}{% endif %}
            {% if has_phone %}{% set strength_points = strength_points + 20 %}{% endif %}
            {% set profile_strength = strength_points %}

            <div class="col-lg-4 mb-3">
                <div class="card-clean p-4 h-100">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <h5 class="mb-1" style="font-weight:800; letter-spacing:-.2px;">Profile Strength</h5>
                            <div class="text-muted">Completed {{ completed_actions }}/{{ total_actions }} essentials.</div>
                        </div>
                        <span class="pill"><i class="fas fa-magic"></i> {{ progress_percent }}%</span>
                    </div>

                    <div class="mt-3 progress-wrap">
                        <div class="progress-bar-custom" style="width: {{ progress_percent }}%;"></div>
                    </div>

                    <ol class="ranked-checklist mt-3">
                        {% for item in actions_all %}
                        <li>
                            <i class="fas {{ 'fa-check-circle text-success' if item in ns.done else 'fa-circle text-muted' }}"></i>
                            <span>{{ item.label }}</span>
                        </li>
                        {% endfor %}
                    </ol>

                    {% if ns.missing|length > 0 %}
                    <div class="mt-3 d-grid">
                        <a href="{{ url_for('doctor_profile_edit') }}" class="btn btn-primary">
                            <i class="fas fa-pen me-2"></i>Do this now
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Your existing actions (same links) -->
            <div class="col-lg-8">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('doctor_profile_edit') }}" class="text-decoration-none">
                            <div class="action-card action-card--primary card h-100">
                                <div class="card-body text-center p-4">
                                    <div style="width: 58px; height: 58px; background: linear-gradient(135deg, var(--dash-1-start) 0%, var(--dash-1-end) 100%); border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 1rem;">
                                        <i class="fas fa-edit fa-2x text-white"></i>
                                    </div>
                                    <h6 class="mb-2" style="font-weight:800; color:var(--text);">Edit Profile</h6>
                                    <small class="text-muted">Update your information</small>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('doctor_reviews') }}" class="text-decoration-none">
                            <div class="action-card action-card--secondary card h-100">
                                <div class="card-body text-center p-4">
                                    <div style="width: 58px; height: 58px; background: linear-gradient(135deg, var(--dash-2-start) 0%, var(--dash-2-end) 100%); border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 1rem;">
                                        <i class="fas fa-comments fa-2x text-white"></i>
                                    </div>
                                    <h6 class="mb-2" style="font-weight:800; color:var(--text);">Manage Reviews</h6>
                                    <small class="text-muted">Respond to patient feedback</small>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-md-6 mb-3">
                        {% if tier_features is defined and tier_features.can_view_analytics %}
                        <a href="{{ url_for('doctor_analytics') }}" class="text-decoration-none">
                            <div class="action-card action-card--secondary card h-100">
                                <div class="card-body text-center p-4">
                                    <div style="width: 58px; height: 58px; background: linear-gradient(135deg, var(--dash-3-start) 0%, var(--dash-3-end) 100%); border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 1rem;">
                                        <i class="fas fa-chart-bar fa-2x text-white"></i>
                                    </div>
                                    <h6 class="mb-2" style="font-weight:800; color:var(--text);">View Analytics</h6>
                                    <small class="text-muted">Track your performance</small>
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <a href="{{ url_for('subscription_pricing') }}" class="text-decoration-none">
                            <div class="action-card action-card--secondary card h-100" style="border-color: rgba(255,193,7,.6);">
                                <div class="card-body text-center p-4">
                                    <div style="width: 58px; height: 58px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 1rem;">
                                        <i class="fas fa-lock fa-2x text-white"></i>
                                    </div>
                                    <h6 class="mb-2" style="font-weight:800; color:var(--text);">
                                        Analytics <span class="badge bg-warning text-dark">Premium</span>
                                    </h6>
                                    <small class="text-muted">Upgrade to unlock insights</small>
                                </div>
                            </div>
                        </a>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="text-decoration-none" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#qrCodeModal">
                            <div class="action-card action-card--secondary card h-100">
                                <div class="card-body text-center p-4">
                                    <div style="width: 58px; height: 58px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 1rem;">
                                        <i class="fas fa-qrcode fa-2x text-white"></i>
                                    </div>
                                    <h6 class="mb-2" style="font-weight:800; color:var(--text);">Review QR Code</h6>
                                    <small class="text-muted">Get more reviews from patients</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('subscription_pricing') }}" class="text-decoration-none">
                            <div class="action-card action-card--secondary card h-100">
                                <div class="card-body text-center p-4">
                                    <div style="width: 58px; height: 58px; background: linear-gradient(135deg, var(--dash-4-start) 0%, var(--dash-4-end) 100%); border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 1rem;">
                                        <i class="fas fa-rocket fa-2x text-white"></i>
                                    </div>
                                    <h6 class="mb-2" style="font-weight:800; color:var(--text);">Increase Visibility</h6>
                                    <small class="text-muted">Get more priority in your city</small>
                                </div>
                            </div>
                        </a>
                    </div>

                </div>
            </div>
        </div>

        <div class="dash-divider" aria-hidden="true"></div>

        <!-- Keep your existing Detailed Information / Working Hours / Help sections unchanged -->
        <!-- (I’m leaving them as-is so you don’t lose any functionality.) -->

        <!-- Detailed Information -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--dash-1-start) 0%, var(--dash-1-end) 100%); border-radius: 16px 16px 0 0; border: none;">
                        <h5 class="mb-0 text-white"><i class="fas fa-user-md me-2"></i>Professional Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Full Name</label>
                            <div class="h6">{{ doctor.name }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Specialty</label>
                            <div class="h6">{{ doctor.specialty.name }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Education</label>
                            <div>{{ doctor.education or '-' }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Medical College</label>
                            <div>{{ doctor.college or '-' }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Practice Address</label>
                            <div>{{ doctor.practice_address or '-' }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Status</label>
                            <div>
                                {% if doctor.is_verified %}
                                <span class="badge" style="background: linear-gradient(135deg, var(--dash-4-start) 0%, var(--dash-4-end) 100%); padding: 0.5rem 1rem; border-radius: 50px;">
                                    <i class="fas fa-check-circle"></i> Verified Doctor
                                </span>
                                {% endif %}
                                {% if doctor.is_featured %}
                                <span class="badge" style="background: linear-gradient(135deg, var(--dash-3-start) 0%, var(--dash-3-end) 100%); padding: 0.5rem 1rem; border-radius: 50px;">
                                    <i class="fas fa-star"></i> Featured
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--dash-2-start) 0%, var(--dash-2-end) 100%); border-radius: 16px 16px 0 0; border: none;">
                        <h5 class="mb-0 text-white"><i class="fas fa-user-circle me-2"></i>Account Settings</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Email Address</label>
                            <div class="h6">{{ user.email }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Phone Number</label>
                            <div>{{ doctor.phone_number or '-' }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Account Type</label>
                            <div>
                                <span class="badge bg-primary" style="padding: 0.5rem 1rem; border-radius: 50px;">
                                    <i class="fas fa-user-md"></i> Verified Doctor
                                </span>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="alert" style="background: rgba(13,138,188, 0.08); border: 1px solid rgba(13,138,188, 0.18); border-radius: 12px;">
                            <small>
                                <i class="fas fa-info-circle me-1 text-primary"></i>
                                <strong>Need to update?</strong> Contact support to change your name, specialty, or city.
                            </small>
                        </div>

                        <div class="d-grid gap-2 mt-3">
                            <a href="{{ url_for('user_profile') }}" class="btn btn-outline-primary">
                                <i class="fas fa-key me-2"></i>Change Password
                            </a>
                            <a href="{{ url_for('doctor_delete_account') }}" class="btn btn-outline-danger">
                                <i class="fas fa-trash-alt me-2"></i>Delete Account
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-divider" aria-hidden="true"></div>

        <!-- Working Hours (your original section stays) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm working-hours-card">
                    <div class="card-header working-hours-header">
                        <h5 class="mb-0 working-hours-title">
                            <i class="far fa-clock me-2"></i>Working Hours
                            {% if tier_features is defined and not tier_features.can_show_hours %}
                            <span class="badge bg-warning text-dark float-end">Premium</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body working-hours-body">
                        {% if tier_features is defined and tier_features.can_show_hours %}
                        <p class="text-muted mb-4 working-hours-intro">
                            <i class="fas fa-info-circle me-1"></i>
                            Set your working hours to help patients know when you're available.
                        </p>

                        <form method="POST" action="{{ url_for('doctor_update_working_hours') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                            <div class="hours-quickfill mb-4">
                                <div class="hours-quickfill-label">Quick fill</div>
                                <div class="hours-quickfill-controls">
                                    <input type="text" class="form-control hours-input" id="hoursQuickFill" placeholder="e.g., 9:00 AM - 5:00 PM">
                                    <div class="hours-quickfill-actions">
                                        <button type="button" class="btn btn-outline-primary btn-sm" data-quickfill="weekdays">Apply to Weekdays</button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" data-quickfill="all">Apply to All</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" data-quickfill="clear">Clear All</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row hours-grid">
                                {% set days_order = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
                                {% set days_display = {'monday': 'Monday', 'tuesday': 'Tuesday', 'wednesday': 'Wednesday', 'thursday': 'Thursday', 'friday': 'Friday', 'saturday': 'Saturday', 'sunday': 'Sunday'} %}
                                {% set working_hours_data = {} %}
                                {% if doctor.working_hours %}
                                    {% set working_hours_data = doctor.working_hours|from_json %}
                                {% endif %}

                                {% for day in days_order %}
                                <div class="col-md-6 mb-3 hours-field">
                                    <label for="{{ day }}" class="form-label hours-label">{{ days_display[day] }}</label>
                                    <div class="hours-input-row">
                                        <input type="text" class="form-control hours-input" id="{{ day }}" name="{{ day }}" data-day="{{ day }}"
                                           value="{{ working_hours_data[day] if working_hours_data and day in working_hours_data else '' }}"
                                           placeholder="e.g., 9:00 AM - 5:00 PM or Closed">
                                        <button type="button" class="btn btn-outline-secondary btn-sm hours-closed-toggle" data-day="{{ day }}">Closed</button>
                                    </div>
                                    <small class="text-muted hours-hint">Leave blank or write "Closed" if not available</small>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="alert alert-info mt-3 hours-tip">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Tips:</strong> Use formats like "9:00 AM - 5:00 PM", "10:00-17:00", or "By appointment only"
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Working Hours
                                </button>
                            </div>
                        </form>

                        {% else %}
                        <div class="text-center py-5">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                                <i class="fas fa-lock fa-3x text-white"></i>
                            </div>
                            <h5 class="mb-3">Working Hours — Premium Feature</h5>
                            <p class="text-muted mb-4">
                                Upgrade to Premium to display working hours and help patients plan visits with confidence.
                            </p>
                            <a href="{{ url_for('subscription_pricing') }}" class="btn btn-warning btn-lg">
                                <i class="fas fa-crown me-2"></i>Upgrade to Premium
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-divider" aria-hidden="true"></div>

        <!-- Help -->
        <div class="card shadow-sm mb-2" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #f8f5ff 0%, #e8f5e9 100%);">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2"><i class="fas fa-question-circle me-2 text-primary"></i>Need Help?</h5>
                        <p class="mb-0 text-muted">Our support team is here to help you succeed on RankSewa.</p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <a href="mailto:support@ranksewa.com" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /dash-wrap -->
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 60px rgba(0,0,0,0.2);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0,0,0,0.08); padding: 1.5rem;">
                <div>
                    <h5 class="modal-title mb-1" id="qrCodeModalLabel">
                        <i class="fas fa-qrcode me-2 text-success"></i>Review QR Code
                    </h5>
                    <small class="text-muted">Share with patients to collect more reviews</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-6 text-center mb-4 mb-md-0">
                        <h6 class="mb-3">Simple QR Code</h6>
                        <img src="{{ url_for('generate_qr_code') }}" alt="QR Code" class="img-fluid" style="max-width: 300px; border: 3px solid #e5e7eb; border-radius: 12px; padding: 1rem;">
                        <div class="mt-3">
                            <a href="{{ url_for('generate_qr_code') }}" download class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-download me-2"></i>Download QR Only
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6 text-center">
                        <h6 class="mb-3">Printable Template</h6>
                        <div class="border rounded p-2 mb-3" style="background: #f9fafb;">
                            <small class="text-muted">Professional design with instructions</small>
                            <div class="mt-2">
                                <i class="fas fa-file-image fa-3x text-primary"></i>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('generate_printable_qr') }}" class="btn btn-success">
                                <i class="fas fa-download me-2"></i>Download Printable (PNG)
                            </a>
                            <a href="{{ url_for('preview_printable_qr') }}" target="_blank" class="btn btn-outline-success">
                                <i class="fas fa-eye me-2"></i>Preview Template
                            </a>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="alert alert-light border" style="border-radius: 12px;">
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-lightbulb text-success"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-2"><strong>How to use:</strong></h6>
                            <ul class="mb-0 ps-3">
                                <li class="mb-1">Print the template and place it at your clinic's front desk</li>
                                <li class="mb-1">Share the QR code digitally on social media or messaging apps</li>
                                <li class="mb-1">Patients scan with their phone camera to leave a review</li>
                                <li class="mb-1">More reviews = better visibility on RankSewa</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-link me-1"></i>
                        QR code links to: <strong>{{ request.url_root }}doctor/{{ doctor.slug }}</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const quickFillInput = document.getElementById('hoursQuickFill');
        const fields = Array.from(document.querySelectorAll('.hours-input[data-day]'));
        const closedToggles = Array.from(document.querySelectorAll('.hours-closed-toggle'));

        const markClosedState = (field, isClosed) => {
            const wrapper = field.closest('.hours-field');
            if (!wrapper) return;
            wrapper.classList.toggle('is-closed', isClosed);
        };

        fields.forEach((field) => {
            const value = (field.value || '').trim().toLowerCase();
            if (value === 'closed') {
                markClosedState(field, true);
            }
        });

        closedToggles.forEach((btn) => {
            btn.addEventListener('click', () => {
                const day = btn.dataset.day;
                const field = fields.find((input) => input.dataset.day === day);
                if (!field) return;
                const isClosed = (field.value || '').trim().toLowerCase() === 'closed';
                field.value = isClosed ? '' : 'Closed';
                markClosedState(field, !isClosed);
            });
        });

        const applyQuickFill = (scope) => {
            if (!quickFillInput) return;
            const value = quickFillInput.value.trim();

            if (scope === 'clear') {
                fields.forEach((field) => {
                    field.value = '';
                    markClosedState(field, false);
                });
                return;
            }

            if (!value) return;

            const targetDays = scope === 'weekdays'
                ? ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                : ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            fields.forEach((field) => {
                if (!targetDays.includes(field.dataset.day)) return;
                const isClosed = (field.value || '').trim().toLowerCase() === 'closed';
                if (!isClosed) {
                    field.value = value;
                }
            });
        };

        document.querySelectorAll('[data-quickfill]').forEach((btn) => {
            btn.addEventListener('click', () => applyQuickFill(btn.dataset.quickfill));
        });
    });
</script>
{% endblock %}
