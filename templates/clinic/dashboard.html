{% extends "base.html" %}

{% block title %}{{ clinic.name }} - Dashboard - RankSewa{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Back Navigation -->
    <nav class="mb-3">
        <a href="{{ url_for('my_clinics') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>My Clinics
        </a>
    </nav>

    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-hospital me-2" style="color: var(--brand);"></i>{{ clinic.name }}
            </h1>
            <p class="text-muted mb-0">
                <i class="fas fa-map-marker-alt me-1"></i>{{ clinic.address }}, {{ clinic.city }}
                <span class="ms-2 badge bg-light text-secondary" style="font-weight: 500;">
                    <i class="fas fa-bolt me-1"></i>Availability & Flow Engine
                </span>
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('clinic_add_doctor', clinic_slug=clinic.slug) }}" class="btn btn-primary">
                <i class="fas fa-user-md me-1"></i> Add Doctor
            </a>
            <a href="{{ url_for('clinic_settings', clinic_slug=clinic.slug) }}" class="btn btn-outline-primary">
                <i class="fas fa-cog me-1"></i> Settings
            </a>
            <a href="{{ url_for('clinic_public_page', clinic_slug=clinic.slug) }}" class="btn btn-outline-secondary" target="_blank">
                <i class="fas fa-external-link-alt me-1"></i> View Public Page
            </a>
        </div>
    </div>

    <!-- Pending Approval / Inactive Notice -->
    {% if not clinic.is_active %}
    <div class="alert alert-warning border-0 shadow-sm mb-4" style="border-radius: 12px;">
        <div class="d-flex align-items-start">
            <i class="fas fa-clock me-3 mt-1" style="font-size: 1.2rem;"></i>
            <div>
                <strong>Pending Approval:</strong>
                Your clinic is under review and not yet visible to patients. Our team verifies clinic identity and public presence before activation. You can still add doctors and configure schedules while you wait. Review typically takes 2-3 business days.
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Important Notice for Clinic Managers -->
    <div class="alert alert-info border-0 shadow-sm mb-4" style="border-radius: 12px; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);">
        <div class="d-flex align-items-start">
            <i class="fas fa-info-circle me-3 mt-1" style="font-size: 1.2rem; color: #0284c7;"></i>
            <div>
                <strong>Online Booking Notice:</strong>
                Online appointments booked through RankSewa may overlap with walk-in patients. Please manage your queue accordingly and inform patients of potential wait times. RankSewa provides this platform as a scheduling tool only and is not responsible for appointment conflicts or delays.
            </div>
        </div>
    </div>

    <!-- Today's Summary -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card h-100" style="border-radius: 12px; border: 1px solid var(--border);">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-day fa-2x mb-2" style="color: var(--brand);"></i>
                    <h3 class="mb-1">{{ today.strftime('%B %d, %Y') }}</h3>
                    <p class="text-muted mb-0">Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="border-radius: 12px; border: 1px solid var(--border);">
                <div class="card-body text-center">
                    <i class="fas fa-user-md fa-2x mb-2" style="color: #3b82f6;"></i>
                    <h3 class="mb-1">{{ clinic_doctors|selectattr('status', 'equalto', 'approved')|list|length }}</h3>
                    <p class="text-muted mb-0">Active Doctors</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="border-radius: 12px; border: 1px solid var(--border);">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2" style="color: #10b981;"></i>
                    {% set total_appointments = namespace(count=0) %}
                    {% for cd_id, appts in today_appointments.items() %}
                        {% set total_appointments.count = total_appointments.count + appts|length %}
                    {% endfor %}
                    <h3 class="mb-1">{{ total_appointments.count }}</h3>
                    <p class="text-muted mb-0">Today's Appointments</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Invitations -->
    {% set pending = clinic_doctors|selectattr('status', 'equalto', 'pending')|list %}
    {% if pending %}
    <div class="alert alert-warning mb-4" style="border-radius: 12px;">
        <h6 class="mb-2"><i class="fas fa-clock me-2"></i>Pending Doctor Invitations</h6>
        <p class="mb-2 small">These doctors have been invited but haven't responded yet:</p>
        <div class="d-flex flex-wrap gap-2">
            {% for cd in pending %}
            <span class="badge bg-warning text-dark">
                <i class="fas fa-user-md me-1"></i>{{ cd.doctor.name }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Coming Soon Features -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card border-0" style="border-radius: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 44px; height: 44px; background: #e0e7ff;">
                        <i class="fas fa-calendar-alt text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">Calendar View</div>
                        <small class="text-muted">See all appointments at a glance</small>
                    </div>
                    <span class="badge bg-secondary">Coming Soon</span>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0" style="border-radius: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 44px; height: 44px; background: #d1fae5;">
                        <i class="fas fa-chart-line text-success"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">Revenue Tracking</div>
                        <small class="text-muted">Track earnings and insights</small>
                    </div>
                    <span class="badge bg-secondary">Coming Soon</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Doctor Tiles -->
    <h4 class="mb-3"><i class="fas fa-user-md me-2"></i>Doctors</h4>

    {% set approved = clinic_doctors|selectattr('status', 'equalto', 'approved')|list %}
    {% if approved %}
    <div class="row g-4">
        {% for cd in approved %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border-radius: 12px; border: 1px solid var(--border); transition: transform 0.2s;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if cd.doctor.photo_url %}
                        {% set photo_path = cd.doctor.photo_url.replace('photos/', '') %}
                        <img src="{{ url_for('serve_photo', filename=photo_path) }}" alt="{{ cd.doctor.name }}"
                             class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                        {% else %}
                        {% set name_parts = cd.doctor.name.replace('Dr. ', '').replace('Dr.', '').split() %}
                        {% set initials = name_parts[0][:1] ~ (name_parts[-1][:1] if name_parts|length > 1 else '') %}
                        <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                             style="width: 60px; height: 60px; background: var(--brand-soft); color: var(--brand); font-weight: bold; font-size: 1.5rem;">
                            {{ initials|upper }}
                        </div>
                        {% endif %}
                        <div>
                            <h5 class="mb-0">{{ cd.doctor.name }}</h5>
                            <small class="text-muted">{{ cd.doctor.specialty.name if cd.doctor.specialty else 'General' }}</small>
                        </div>
                    </div>

                    <!-- Today's Stats -->
                    {% set appts = today_appointments.get(cd.id, []) %}
                    <div class="d-flex justify-content-between mb-3 p-2" style="background: var(--brand-soft); border-radius: 8px;">
                        <div class="text-center">
                            <div class="fw-bold">{{ appts|length }}</div>
                            <small class="text-muted">Today</small>
                        </div>
                        <div class="text-center">
                            <div class="fw-bold text-success">{{ appts|selectattr('status', 'equalto', 'completed')|list|length }}</div>
                            <small class="text-muted">Done</small>
                        </div>
                        <div class="text-center">
                            <div class="fw-bold text-warning">{{ appts|selectattr('status', 'in', ['booked', 'confirmed', 'checked_in'])|list|length }}</div>
                            <small class="text-muted">Waiting</small>
                        </div>
                    </div>

                    {% if cd.consultation_fee %}
                    <p class="small text-muted mb-2">
                        <i class="fas fa-money-bill me-1"></i>Consultation: NPR {{ cd.consultation_fee }}
                    </p>
                    {% endif %}

                    <a href="{{ url_for('clinic_doctor_queue', clinic_slug=clinic.slug, clinic_doctor_id=cd.id) }}"
                       class="btn btn-primary w-100">
                        <i class="fas fa-list-ol me-1"></i> Manage Queue
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info" style="border-radius: 12px;">
        <div class="text-center py-4">
            <i class="fas fa-user-md fa-3x mb-3" style="color: var(--brand);"></i>
            <h5>No Doctors Yet</h5>
            <p class="text-muted mb-3">Add verified doctors from RankSewa to start accepting appointments.</p>
            <a href="{{ url_for('clinic_add_doctor', clinic_slug=clinic.slug) }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Add Your First Doctor
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
</style>
{% endblock %}
