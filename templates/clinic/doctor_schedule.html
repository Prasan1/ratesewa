{% extends "base.html" %}

{% block title %}Set Schedule - {{ clinic_doctor.clinic.name }} - RankSewa{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <a href="{{ url_for('doctor_clinic_invitations') }}" class="btn btn-outline-secondary mb-4">
                <i class="fas fa-arrow-left me-1"></i> Back to Affiliations
            </a>

            <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                <div class="card-body p-4">
                    <h3 class="mb-1">
                        <i class="fas fa-calendar-alt me-2" style="color: var(--brand);"></i>Set Your Schedule
                    </h3>
                    <p class="text-muted mb-4">{{ clinic_doctor.clinic.name }}</p>

                    <form method="POST" action="{{ url_for('doctor_clinic_schedule', clinic_doctor_id=clinic_doctor.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Slot Duration -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Appointment Duration</label>
                            <select class="form-select" name="slot_duration">
                                <option value="10" {{ 'selected' if clinic_doctor.slot_duration_minutes == 10 }}>10 minutes</option>
                                <option value="15" {{ 'selected' if clinic_doctor.slot_duration_minutes == 15 or not clinic_doctor.slot_duration_minutes }}>15 minutes</option>
                                <option value="20" {{ 'selected' if clinic_doctor.slot_duration_minutes == 20 }}>20 minutes</option>
                                <option value="30" {{ 'selected' if clinic_doctor.slot_duration_minutes == 30 }}>30 minutes</option>
                                <option value="45" {{ 'selected' if clinic_doctor.slot_duration_minutes == 45 }}>45 minutes</option>
                                <option value="60" {{ 'selected' if clinic_doctor.slot_duration_minutes == 60 }}>60 minutes</option>
                            </select>
                        </div>

                        <!-- Weekly Schedule -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Weekly Schedule</label>
                            <p class="text-muted small">Select the days and times you're available at this clinic.</p>
                            <div class="alert alert-warning py-2 small">
                                <i class="fas fa-clock me-1"></i>
                                <strong>Time format:</strong> Use 24-hour format. For example: 10:00 AM = <code>10:00</code>, 6:00 PM = <code>18:00</code>
                            </div>

                            {% set days = [('0', 'Sunday'), ('1', 'Monday'), ('2', 'Tuesday'), ('3', 'Wednesday'), ('4', 'Thursday'), ('5', 'Friday'), ('6', 'Saturday')] %}

                            {% for day_num, day_name in days %}
                            {% set existing = schedules.get(day_num|int) %}
                            <div class="card mb-2" style="border-radius: 8px;">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days[]" value="{{ day_num }}"
                                                       id="day{{ day_num }}" {{ 'checked' if existing }}
                                                       onchange="toggleDayInputs({{ day_num }})">
                                                <label class="form-check-label fw-semibold" for="day{{ day_num }}">
                                                    {{ day_name }}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="time" class="form-control form-control-sm" name="start_time_{{ day_num }}"
                                                   id="start_{{ day_num }}" value="{{ existing.start_time.strftime('%H:%M') if existing else '09:00' }}"
                                                   {{ '' if existing else 'disabled' }}>
                                        </div>
                                        <div class="col-md-1 text-center">to</div>
                                        <div class="col-md-3">
                                            <input type="time" class="form-control form-control-sm" name="end_time_{{ day_num }}"
                                                   id="end_{{ day_num }}" value="{{ existing.end_time.strftime('%H:%M') if existing else '17:00' }}"
                                                   {{ '' if existing else 'disabled' }}>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control form-control-sm" name="max_appointments_{{ day_num }}"
                                                   id="max_{{ day_num }}" value="{{ existing.max_appointments if existing else 20 }}"
                                                   placeholder="Max" min="1" max="100" {{ '' if existing else 'disabled' }}>
                                            <small class="text-muted">max patients</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Once you set your schedule, patients will be able to book appointments at {{ clinic_doctor.clinic.name }}.
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Save Schedule
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleDayInputs(dayNum) {
    const checkbox = document.getElementById('day' + dayNum);
    const startInput = document.getElementById('start_' + dayNum);
    const endInput = document.getElementById('end_' + dayNum);
    const maxInput = document.getElementById('max_' + dayNum);

    startInput.disabled = !checkbox.checked;
    endInput.disabled = !checkbox.checked;
    maxInput.disabled = !checkbox.checked;
}

// Validate end time is after start time
function validateScheduleTimes() {
    const days = ['0', '1', '2', '3', '4', '5', '6'];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    let errors = [];

    for (let i = 0; i < days.length; i++) {
        const checkbox = document.getElementById('day' + days[i]);
        if (checkbox && checkbox.checked) {
            const startInput = document.getElementById('start_' + days[i]);
            const endInput = document.getElementById('end_' + days[i]);

            if (startInput.value && endInput.value) {
                if (endInput.value <= startInput.value) {
                    errors.push(dayNames[i] + ': End time (' + formatTime(endInput.value) + ') must be after start time (' + formatTime(startInput.value) + '). Did you mean ' + formatTime(addTwelveHours(endInput.value)) + ' (PM) instead?');
                    endInput.style.borderColor = 'red';
                } else {
                    endInput.style.borderColor = '';
                }
            }
        }
    }

    if (errors.length > 0) {
        alert('Schedule Error:\\n\\n' + errors.join('\\n\\n'));
        return false;
    }
    return true;
}

function formatTime(time24) {
    const [hours, minutes] = time24.split(':');
    const h = parseInt(hours);
    const suffix = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return h12 + ':' + minutes + ' ' + suffix;
}

function addTwelveHours(time24) {
    const [hours, minutes] = time24.split(':');
    const newHours = (parseInt(hours) + 12) % 24;
    return newHours.toString().padStart(2, '0') + ':' + minutes;
}

// Add validation on form submit
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateScheduleTimes()) {
                e.preventDefault();
            }
        });
    }

    // Also validate on time input change
    document.querySelectorAll('input[type="time"]').forEach(function(input) {
        input.addEventListener('change', validateScheduleTimes);
    });
});
</script>
{% endblock %}
