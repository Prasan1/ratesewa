{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
    <div>
        <h2 class="mb-1">Manage Users</h2>
        <p class="text-muted mb-0">Review accounts and take action carefully.</p>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-danger btn-sm" href="{{ url_for('admin_detect_spam_users') }}">
            <i class="fas fa-robot me-1"></i> Detect Spam
        </a>
        {% if show_tests %}
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_users') }}">
                Hide test users
            </a>
        {% else %}
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_users', show_tests=1) }}">
                Show test users
            </a>
        {% endif %}
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>User</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Active</th>
                <th>Joined</th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    <div class="fw-semibold">{{ user.name }}</div>
                    <div class="text-muted small">{{ user.email }}</div>
                    {% if not user.email_verified %}
                    <span class="badge bg-secondary" style="font-size: 0.65rem;">Email not verified</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_admin %}
                        <span class="badge bg-danger"><i class="fas fa-shield-alt me-1"></i>Admin</span>
                    {% elif user.role == 'doctor' %}
                        <span class="badge bg-primary"><i class="fas fa-user-md me-1"></i>Doctor</span>
                    {% elif user.role == 'clinic_manager' %}
                        <span class="badge bg-info"><i class="fas fa-hospital me-1"></i>Clinic Mgr</span>
                    {% else %}
                        <span class="badge bg-secondary"><i class="fas fa-user me-1"></i>User</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                </td>
                <td class="small">
                    {% if user.last_login_at %}
                        {% set diff = (now - user.last_login_at).total_seconds() %}
                        {% if diff < 3600 %}
                            <span class="text-success fw-semibold"><i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>{{ (diff / 60)|int }} min ago</span>
                        {% elif diff < 86400 %}
                            <span class="text-success"><i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>{{ (diff / 3600)|int }} hrs ago</span>
                        {% elif diff < 604800 %}
                            <span class="text-primary">{{ (diff / 86400)|int }} days ago</span>
                        {% elif diff < 2592000 %}
                            <span class="text-muted">{{ (diff / 604800)|int }} weeks ago</span>
                        {% else %}
                            <span class="text-muted">{{ user.last_login_at.strftime('%b %d') }}</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">Never</span>
                    {% endif %}
                </td>
                <td class="text-muted small">
                    {% if user.created_at %}
                        {{ user.created_at.strftime('%b %d, %Y') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-end">
                    {% if session.get('user_id') != user.id %}
                    <div class="d-flex gap-1 justify-content-end flex-wrap">
                        <!-- View Reviews -->
                        <a href="{{ url_for('admin_user_reviews', user_id=user.id) }}" class="btn btn-sm btn-outline-info" title="View reviews by this user">
                            <i class="fas fa-star"></i>
                        </a>

                        <!-- Toggle Admin Status -->
                        <form method="post" action="{{ url_for('admin_user_toggle_admin', user_id=user.id) }}" class="d-inline js-admin-toggle" data-name="{{ user.name }}" data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            {% if user.is_admin %}
                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Remove admin privileges">
                                <i class="fas fa-user-minus"></i>
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Make admin">
                                <i class="fas fa-user-shield"></i>
                            </button>
                            {% endif %}
                        </form>

                        <!-- Activate/Deactivate -->
                        <form method="post" action="{{ url_for('admin_user_status', user_id=user.id) }}" class="d-inline js-user-status" data-email="{{ user.email }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            {% if user.is_active %}
                            <input type="hidden" name="action" value="deactivate"/>
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Deactivate user">
                                <i class="fas fa-ban"></i>
                            </button>
                            {% else %}
                            <input type="hidden" name="action" value="activate"/>
                            <button type="submit" class="btn btn-sm btn-success" title="Reactivate user">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            {% endif %}
                        </form>
                    </div>
                    {% else %}
                    <span class="badge bg-info"><i class="fas fa-user-shield me-1"></i>You</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center text-muted py-4">No users found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination and pagination.pages > 1 %}
<nav aria-label="User list pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_users', page=pagination.prev_num) }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.pages, pagination.page + 2]|min %}

        {% if start_page > 1 %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin_users', page=1) }}">1</a></li>
        {% if start_page > 2 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('admin_users', page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}

        {% if end_page < pagination.pages %}
        {% if end_page < pagination.pages - 1 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin_users', page=pagination.pages) }}">{{ pagination.pages }}</a></li>
        {% endif %}

        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_users', page=pagination.next_num) }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
    </ul>
    <p class="text-center text-muted small">
        Page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total }} users total)
    </p>
</nav>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Deactivate user requires typing email
document.querySelectorAll('.js-user-status').forEach(function(form) {
    form.addEventListener('submit', function(event) {
        const action = form.querySelector('input[name="action"]');
        if (!action || action.value !== 'deactivate') {
            return;
        }
        const email = form.dataset.email || '';
        const typed = prompt(`Type the user's email to confirm deactivation:\n${email}`);
        if (!typed || typed.trim().toLowerCase() !== email.toLowerCase()) {
            event.preventDefault();
            alert('Deactivation cancelled.');
        }
    });
});

// Admin toggle requires confirmation with typing
document.querySelectorAll('.js-admin-toggle').forEach(function(form) {
    form.addEventListener('submit', function(event) {
        const name = form.dataset.name || 'this user';
        const isAdmin = form.dataset.isAdmin === 'true';

        if (isAdmin) {
            // Removing admin - simple confirm
            if (!confirm(`Remove admin privileges from ${name}?`)) {
                event.preventDefault();
            }
        } else {
            // Making admin - require typing "ADMIN"
            const typed = prompt(`This grants full admin access to ${name}.\n\nType "ADMIN" to confirm:`);
            if (!typed || typed.trim().toUpperCase() !== 'ADMIN') {
                event.preventDefault();
                alert('Admin grant cancelled.');
            }
        }
    });
});
</script>
{% endblock %}
