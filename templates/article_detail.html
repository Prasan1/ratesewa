{% extends "base.html" %}

{% block title %}{{ article.title }} - The Nepal Health Journal - RankSewa{% endblock %}

{% block head %}
<!-- SEO Meta Tags -->
<meta name="description" content="{{ article.meta_description or (article.summary or article.content[:160]) }}">
<meta name="keywords" content="{{ article.meta_keywords or article.category.name }}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.url }}">
<meta property="og:title" content="{{ article.title }}">
<meta property="og:description" content="{{ article.meta_description or (article.summary or article.content[:160]) }}">
<meta property="og:image" content="{{ article.featured_image or 'https://picsum.photos/1200/630' }}">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="{{ request.url }}">
<meta property="twitter:title" content="{{ article.title }}">
<meta property="twitter:description" content="{{ article.meta_description or (article.summary or article.content[:160]) }}">
<meta property="twitter:image" content="{{ article.featured_image or 'https://picsum.photos/1200/630' }}">
{% endblock %}

{% block content %}
<article class="article-page">
    <!-- Back Navigation -->
    <nav class="article-nav">
        <a href="{{ url_for('health_digest') }}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            <span>The Nepal Health Journal</span>
        </a>
    </nav>

    <!-- Article Header -->
    <header class="article-header">
        <div class="article-header-inner">
            <a href="{{ url_for('health_digest', category=article.category.slug) }}" class="article-category">
                {{ article.category.name }}
            </a>
            <h1 class="article-title">{{ article.title }}</h1>
            {% if article.summary %}
            <p class="article-dek">{{ article.summary }}</p>
            {% endif %}
            <div class="article-byline">
                <span>By <strong>{{ article.author_name }}</strong></span>
                <span class="sep">/</span>
                <span>{{ article.published_at.strftime('%B %d, %Y') if article.published_at else article.created_at.strftime('%B %d, %Y') }}</span>
                <span class="sep">/</span>
                <span>{{ article.read_time }} min read</span>
            </div>
        </div>
    </header>

    <!-- Featured Image -->
    {% if article.featured_image %}
    <figure class="article-hero">
        {% if article.featured_image.startswith('/static/') or article.featured_image.startswith('http') %}
        <img src="{{ article.featured_image }}"
        {% else %}
        <img src="{{ url_for('static', filename='img/' + article.featured_image) }}"
        {% endif %}
             alt="{{ article.title }}"
             loading="eager">
    </figure>
    {% endif %}

    <!-- Article Body -->
    <div class="article-container">
        <!-- Medical Disclaimer -->
        <aside class="article-callout article-callout--warning">
            <strong>Medical Disclaimer:</strong> This article is for informational purposes only and does not replace professional medical advice. Consult a healthcare provider for medical concerns.
        </aside>

        <!-- Early CTA - Catches users before they bounce -->
        <aside class="article-callout article-callout--cta" style="background: linear-gradient(135deg, #0d8abc 0%, #0ea5e9 100%); color: white; border: none; margin: 1.5rem 0;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <strong style="font-size: 1.1rem;"><i class="fas fa-user-md me-2"></i>Need to consult a doctor?</strong>
                    <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Find verified specialists in Nepal - it's free to search.</p>
                </div>
                <a href="{{ url_for('index') }}" class="btn btn-light" style="white-space: nowrap;">
                    <i class="fas fa-search me-1"></i>Find a Doctor
                </a>
            </div>
        </aside>

        <!-- Quick Answer -->
        {% if article.quick_answer %}
        <aside class="article-callout article-callout--highlight">
            <strong>Quick Answer:</strong>
            {{ article.quick_answer | safe }}
        </aside>
        {% endif %}

        <!-- Table of Contents -->
        {% if article.read_time and article.read_time >= 5 %}
        <nav class="article-toc" id="tableOfContents">
            <h4>In This Article</h4>
            <div class="toc-links" id="tocContent">
                <!-- Generated by JavaScript -->
            </div>
        </nav>
        {% endif %}

        <!-- Main Content -->
        <div class="article-content" id="articleBody">
            {{ article.content | markdown | safe }}
        </div>

        <!-- Share Section -->
        <div class="article-share">
            <span class="share-label">Share this article</span>
            <div class="share-buttons">
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" class="share-btn">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://twitter.com/intent/tweet?url={{ request.url }}&text={{ article.title }}" target="_blank" class="share-btn">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://wa.me/?text={{ article.title }}%20{{ request.url }}" target="_blank" class="share-btn">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url }}" target="_blank" class="share-btn">
                    <i class="fab fa-linkedin-in"></i>
                </a>
                <button class="share-btn" onclick="copyLink()">
                    <i class="fas fa-link"></i>
                </button>
            </div>
        </div>

        <!-- Related Doctors -->
        {% if related_doctors %}
        <section class="article-doctors">
            <h3>Consult Expert {{ article.related_specialty.name }}s</h3>
            <p>Connect with verified specialists for personalized medical advice.</p>
            <div class="doctors-grid">
                {% for doctor in related_doctors[:4] %}
                <a href="{{ url_for('doctor_profile', slug=doctor.slug) }}" class="doctor-card-v2">
                    {% if doctor.photo_url %}
                    {% set photo_path = doctor.photo_url.replace('photos/', '') %}
                    <img src="{{ url_for('serve_photo', filename=photo_path) }}"
                         alt="{{ doctor.name }}"
                         class="doctor-photo"
                         onerror="this.src='{{ doctor|doctor_avatar }}'">
                    {% else %}
                    <img src="{{ doctor|doctor_avatar }}" alt="{{ doctor.name }}" class="doctor-photo">
                    {% endif %}
                    <div class="doctor-details">
                        <div class="doctor-name-row">
                            <strong>{{ doctor.name }}</strong>
                            {% if doctor.is_verified %}
                            <span class="verified-tag">Verified</span>
                            {% endif %}
                        </div>
                        <span class="doctor-spec">{{ doctor.specialty.name }}</span>
                        <span class="doctor-loc">{{ doctor.city.name }} &bull; {{ doctor.experience }} yrs exp</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Related Articles -->
        {% if related_articles %}
        <section class="article-related">
            <h3>Related Articles</h3>
            <div class="related-grid">
                {% for rel_article in related_articles[:3] %}
                <a href="{{ url_for('article_detail', slug=rel_article.slug) }}" class="related-card">
                    <span class="related-category">{{ rel_article.category.name }}</span>
                    <h4>{{ rel_article.title }}</h4>
                    <span class="related-meta">{{ rel_article.read_time }} min read</span>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>

    <!-- CTA Section -->
    <section class="article-cta">
        <div class="cta-inner">
            <h3>Find the Right Doctor for You</h3>
            <p>Search verified healthcare providers across Nepal</p>
            <a href="{{ url_for('index') }}" class="cta-button">Search Doctors</a>
        </div>
    </section>

    <!-- Back to Journal -->
    <div class="article-back">
        <a href="{{ url_for('health_digest') }}">
            <i class="fas fa-arrow-left"></i> Back to The Nepal Health Journal
        </a>
    </div>
</article>

<!-- Floating CTA for Mobile - Shows after scrolling -->
<div id="floatingCta" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none;">
    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg shadow-lg" style="border-radius: 50px; padding: 12px 24px; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-user-md"></i>
        <span>Find a Doctor</span>
    </a>
</div>

<script>
function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        alert('Link copied to clipboard!');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const articleBody = document.getElementById('articleBody');
    const tocContent = document.getElementById('tocContent');

    if (articleBody && tocContent) {
        const headings = articleBody.querySelectorAll('h2, h3');
        let tocHTML = '';

        headings.forEach(function(heading, index) {
            if (!heading.id) {
                heading.id = 'section-' + index;
            }
            const level = heading.tagName.toLowerCase();
            const indent = level === 'h3' ? ' class="toc-indent"' : '';
            tocHTML += `<a href="#${heading.id}"${indent}>${heading.textContent}</a>`;
        });

        if (tocHTML) {
            tocContent.innerHTML = tocHTML;
        } else {
            const tocBox = document.getElementById('tableOfContents');
            if (tocBox) tocBox.style.display = 'none';
        }
    }

    // Floating CTA - show after scrolling 40% of page
    const floatingCta = document.getElementById('floatingCta');
    if (floatingCta) {
        let lastScrollY = 0;
        window.addEventListener('scroll', function() {
            const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;

            // Show after scrolling 40%, hide when near bottom (90%)
            if (scrollPercent > 40 && scrollPercent < 90) {
                floatingCta.style.display = 'block';
            } else {
                floatingCta.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
