{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm profile-card">
            <div class="profile-banner">
                <div class="profile-avatar-circle" aria-hidden="true">
                    {{ user.name[:1]|upper }}
                </div>
            </div>
            <div class="card-body text-center">
                <h4 class="mb-1">{{ user.name }}</h4>
                <p class="text-muted mb-2">{{ user.email }}</p>
                <div class="profile-meta">
                    <span><i class="fas fa-calendar-alt me-1"></i>Joined {{ user.created_at.strftime('%b %Y') }}</span>
                    <span><i class="fas fa-star me-1"></i>{{ user.review_count }} reviews</span>
                </div>
                <div class="profile-meta">
                    <span><i class="fas fa-thumbs-up me-1"></i>{{ total_helpful_received }} helpful</span>
                    <span><i class="fas fa-trophy me-1"></i>{{ tier_name }}</span>
                </div>
                {% if user.review_count > 0 %}
                <p class="profile-about">Thanks for helping others choose better care.</p>
                {% else %}
                <p class="profile-about">Share your first review and build your profile.</p>
                {% endif %}
                <div class="profile-tags">
                    {% if user.email_verified %}
                    <span class="badge bg-success">Email Verified</span>
                    {% endif %}
                    {% if session.get('is_admin') %}
                    <span class="badge bg-primary">Admin</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Change Password Section -->
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#changePasswordForm" aria-expanded="false" aria-controls="changePasswordForm">
                    <i class="fas fa-lock me-2"></i>Change Password
                </button>

                <div class="collapse mt-3" id="changePasswordForm">
                    <form method="POST" action="{{ url_for('change_password') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <div class="mb-3">
                            <label for="current_password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                            <div class="form-text">At least 6 characters</div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="6">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-key me-2"></i>Update Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Gamification Stats Card -->
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-trophy me-2 text-warning"></i>Reviewer Stats
                </h5>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Tier:</span>
                        <strong class="
                            {% if tier == 'platinum' %}text-info
                            {% elif tier == 'gold' %}text-warning
                            {% elif tier == 'silver' %}text-secondary
                            {% else %}text-brown
                            {% endif %}">
                            {{ tier_name }}
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Points:</span>
                        <strong>{{ total_points }}</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Reviews Written:</span>
                        <strong>{{ user.review_count }}</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Helpful Votes:</span>
                        <strong>{{ total_helpful_received }}</strong>
                    </div>
                </div>

                <!-- Tier Progress Bar -->
                <div class="mb-3">
                    <small class="text-muted">Progress to next tier:</small>
                    <div class="progress" style="height: 20px;">
                        {% if tier == 'bronze' %}
                        <div class="progress-bar bg-secondary" role="progressbar"
                             style="width: {{ (total_points / 51 * 100) | round | int }}%"
                             aria-valuenow="{{ total_points }}" aria-valuemin="0" aria-valuemax="51">
                            {{ total_points }}/51
                        </div>
                        {% elif tier == 'silver' %}
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width: {{ ((total_points - 51) / 100 * 100) | round | int }}%"
                             aria-valuenow="{{ total_points - 51 }}" aria-valuemin="0" aria-valuemax="100">
                            {{ total_points }}/151
                        </div>
                        {% elif tier == 'gold' %}
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width: {{ ((total_points - 151) / 149 * 100) | round | int }}%"
                             aria-valuenow="{{ total_points - 151 }}" aria-valuemin="0" aria-valuemax="149">
                            {{ total_points }}/300
                        </div>
                        {% else %}
                        <div class="progress-bar bg-info" role="progressbar" style="width: 100%">
                            Max Tier!
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if next_tier %}
                <div class="next-goal mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>Next tier: {{ next_tier|capitalize }}</strong>
                        <span class="text-muted small">{{ points_to_next }} pts to go</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: {{ ((total_points / (total_points + points_to_next)) * 100) | round | int }}%"
                             aria-valuenow="{{ total_points }}" aria-valuemin="0" aria-valuemax="{{ total_points + points_to_next }}">
                        </div>
                    </div>
                    <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-primary mt-2 w-100">
                        Write a review to level up
                    </a>
                </div>
                {% endif %}

                <!-- Badges -->
                {% if user_badges %}
                <div class="mt-3">
                    <small class="text-muted d-block mb-2">Badges Earned:</small>
                    <div class="d-flex flex-wrap gap-2">
                        {% for user_badge in user_badges %}
                        <span class="badge bg-light text-dark border"
                              title="{{ user_badge.badge_definition.description }}"
                              style="font-size: 1rem; padding: 0.5rem;">
                            {{ user_badge.badge_definition.icon }} {{ user_badge.badge_definition.name }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="mt-3">
                    <small class="text-muted">No badges earned yet. Write reviews to unlock badges!</small>
                </div>
                {% endif %}

                <div class="mt-3">
                    <a href="{{ url_for('leaderboard') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-trophy me-1"></i>View Leaderboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- Doctor Verification Status -->
        {% if verification_request %}
        {% if verification_request.status == 'pending' %}
        <div class="alert alert-warning border-warning shadow-sm mb-4">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-hourglass-half fa-2x text-warning me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">
                        <i class="fas fa-check-circle me-2"></i>Doctor Verification Pending
                    </h5>
                    <p class="mb-2">Your verification request is under review by our admin team.</p>
                    <div class="row g-2 small">
                        <div class="col-md-4">
                            <strong><i class="fas fa-calendar me-1"></i>Submitted:</strong><br>
                            {{ verification_request.created_at.strftime('%b %d, %Y') }}
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-info-circle me-1"></i>Status:</strong><br>
                            <span class="badge bg-warning text-dark">Pending Review</span>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-clock me-1"></i>Expected Response:</strong><br>
                            2-3 business days
                        </div>
                    </div>
                    <hr class="my-2">
                    <p class="mb-0 small">
                        <i class="fas fa-envelope me-1"></i>
                        You'll receive an email notification at <strong>{{ user.email }}</strong> once your profile is verified.
                    </p>
                </div>
            </div>
        </div>
        {% elif verification_request.status == 'rejected' %}
        <div class="alert alert-danger border-danger shadow-sm mb-4">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-times-circle fa-2x text-danger me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">Verification Rejected</h5>
                    <p class="mb-2">{{ verification_request.admin_notes or 'Please contact support for details.' }}</p>
                    {% if verification_request.is_new_doctor %}
                    <a href="{{ url_for('doctor_self_register') }}" class="btn btn-outline-danger btn-sm">
                        Resubmit Verification
                    </a>
                    {% else %}
                    <a href="{{ url_for('claim_profile') }}" class="btn btn-outline-danger btn-sm">
                        Resubmit Verification
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% elif verification_request.status == 'approved' %}
        <div class="alert alert-success border-success shadow-sm mb-4">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">Verification Approved</h5>
                    <p class="mb-2">Your doctor profile is verified and live.</p>
                    {% if user.doctor_id %}
                    <a href="{{ url_for('doctor_dashboard') }}" class="btn btn-success btn-sm">
                        Go to Doctor Dashboard
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% elif not user.doctor_id %}
        <div class="alert alert-light border-start border-info border-3 alert-dismissible fade show mb-4" role="alert">
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            <small class="text-muted">
                <i class="fas fa-user-md me-1"></i><strong>Are you a doctor?</strong>
                <a href="{{ url_for('claim_profile') }}" class="alert-link">Claim your profile</a> or
                <a href="{{ url_for('doctor_self_register') }}" class="alert-link">create a new one</a> to get verified.
            </small>
        </div>
        {% endif %}

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm stat-card">
                    <div class="card-body">
                        <div class="stat-label">Reviews</div>
                        <div class="stat-value">{{ user.review_count }}</div>
                        <div class="stat-meta">Your published reviews</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm stat-card">
                    <div class="card-body">
                        <div class="stat-label">Helpful Votes</div>
                        <div class="stat-value">{{ total_helpful_received }}</div>
                        <div class="stat-meta">Community appreciation</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm stat-card">
                    <div class="card-body">
                        <div class="stat-label">Appointments</div>
                        <div class="stat-value">{{ appointments|length }}</div>
                        <div class="stat-meta">Booked so far</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Recent Activity
                    </h4>
                    <span class="text-muted small">Last 6 items</span>
                </div>
                {% if activities %}
                <div class="activity-list">
                    {% for activity in activities %}
                    <a class="activity-item" href="{{ activity.url }}">
                        <div class="activity-icon">
                            {% if activity.type == 'review' %}
                            <i class="fas fa-star"></i>
                            {% else %}
                            <i class="fas fa-calendar-check"></i>
                            {% endif %}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">{{ activity.title }}</div>
                            <div class="activity-meta">{{ activity.meta }} â€¢ {{ activity.date.strftime('%b %d, %Y') }}</div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No activity yet. Start by booking an appointment or leaving a review.</p>
                <a href="{{ url_for('index') }}" class="btn btn-sm btn-primary mt-3">
                    <i class="fas fa-search me-2"></i>Find a Doctor
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Appointments Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h4 class="card-title mb-3">
                    <i class="fas fa-calendar-alt me-2"></i>My Appointments
                </h4>

                {% if appointments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Doctor</th>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for appt in appointments %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('doctor_profile', slug=appt.doctor.slug) }}">
                                        {{ appt.doctor.name }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ appt.doctor.specialty.name }}</small>
                                </td>
                                <td>
                                    {{ appt.appointment_date.strftime('%B %d, %Y') }}<br>
                                    <small class="text-muted">{{ appt.appointment_time.strftime('%I:%M %p') }}</small>
                                </td>
                                <td>
                                    {% if appt.status == 'pending' %}
                                    <span class="badge bg-warning">Pending</span>
                                    {% elif appt.status == 'confirmed' %}
                                    <span class="badge bg-success">Confirmed</span>
                                    {% elif appt.status == 'cancelled' %}
                                    <span class="badge bg-danger">Cancelled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if appt.is_ratable %}
                                    <a href="{{ url_for('doctor_profile', slug=appt.doctor.slug) }}#ratingModal" class="btn btn-sm btn-primary">
                                        <i class="fas fa-star"></i> Rate
                                    </a>
                                    {% elif appt.is_rated %}
                                    <span class="text-success"><i class="fas fa-check-circle"></i> Rated</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">You haven't booked any appointments yet.</p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Find a Doctor
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Ratings Section -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-3">
                    <i class="fas fa-star me-2"></i>My Reviews
                </h4>

                {% if ratings %}
                {% for rating in ratings %}
                <div class="review mb-4 pb-3 border-bottom">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <a href="{{ url_for('doctor_profile', slug=rating.doctor.slug) }}">
                                <h6 class="mb-0">{{ rating.doctor.name }}</h6>
                            </a>
                            <small class="text-muted">{{ rating.doctor.specialty.name }}</small>
                        </div>
                        <div>
                            {% for i in range(rating.rating) %}
                            <i class="fas fa-star text-warning"></i>
                            {% endfor %}
                            {% for i in range(5 - rating.rating) %}
                            <i class="far fa-star text-warning"></i>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="card-text">{{ rating.comment }}</p>
                    <small class="text-muted">Reviewed on {{ rating.created_at.strftime('%B %d, %Y') }}</small>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">You haven't written any reviews yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
