{% extends "base.html" %}

{% block title %}Manage Reviews - Doctor Dashboard - RankSewa{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments me-2"></i>Manage Reviews</h2>
                <a href="{{ url_for('doctor_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>

            {% if ratings %}
            <!-- Reviews List -->
            {% for rating in ratings %}
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <!-- Review Header -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">{{ rating.user_name }}</h6>
                            <div class="mb-2">
                                {% for i in range(1, 6) %}
                                    {% if i <= rating.rating %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="ms-2 text-muted">{{ rating.rating }}/5</span>
                            </div>
                        </div>
                        <small class="text-muted">
                            {{ rating.created_at.strftime('%b %d, %Y') }}
                        </small>
                    </div>

                    <!-- Review Comment -->
                    <p class="mb-3">{{ rating.comment }}</p>

                    <!-- Existing Response -->
                    {% if rating.doctor_response %}
                    <div class="bg-light p-3 rounded border-start border-primary border-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong><i class="fas fa-reply me-1"></i>Your Response:</strong>
                            <small class="text-muted">
                                {{ rating.doctor_response.created_at.strftime('%b %d, %Y') }}
                                {% if rating.doctor_response.updated_at != rating.doctor_response.created_at %}
                                (edited {{ rating.doctor_response.updated_at.strftime('%b %d, %Y') }})
                                {% endif %}
                            </small>
                        </div>
                        <p class="mb-2">{{ rating.doctor_response.response_text }}</p>
                        <button class="btn btn-sm btn-outline-primary"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#edit-response-{{ rating.id }}">
                            <i class="fas fa-edit me-1"></i>Edit Response
                        </button>
                    </div>

                    <!-- Edit Response Form (Collapsed) -->
                    <div class="collapse" id="edit-response-{{ rating.id }}">
                        <form method="POST" action="{{ url_for('doctor_respond_to_review', rating_id=rating.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-2">
                                <textarea class="form-control"
                                          name="response_text"
                                          rows="3"
                                          placeholder="Update your response..."
                                          required>{{ rating.doctor_response.response_text }}</textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-save me-1"></i>Update Response
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#edit-response-{{ rating.id }}">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                    {% else %}
                    <!-- No Response - Show Add Form -->
                    <div class="border-top pt-3">
                        <button class="btn btn-sm btn-success mb-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#respond-{{ rating.id }}">
                            <i class="fas fa-reply me-1"></i>Respond to this Review
                        </button>

                        <!-- Response Form (Collapsed) -->
                        <div class="collapse" id="respond-{{ rating.id }}">
                            <form method="POST" action="{{ url_for('doctor_respond_to_review', rating_id=rating.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-2">
                                    <textarea class="form-control"
                                              name="response_text"
                                              rows="3"
                                              placeholder="Thank the patient, address their feedback professionally..."
                                              required></textarea>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Be professional, courteous, and constructive in your response
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>Post Response
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm btn-secondary"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#respond-{{ rating.id }}">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- No Reviews Yet -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No reviews yet</strong>
                <p class="mb-0 mt-2">When patients leave reviews, they will appear here. You'll be able to respond to each review professionally.</p>
            </div>
            {% endif %}

            <!-- Response Guidelines -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Best Practices for Responding to Reviews</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Thank patients for taking the time to share their feedback</li>
                        <li>Address specific concerns mentioned in the review professionally</li>
                        <li>Avoid sharing any patient's medical information</li>
                        <li>Keep responses concise and constructive</li>
                        <li>If a patient had a negative experience, acknowledge it and explain how you're improving</li>
                        <li>Maintain a professional tone even if the review is critical</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
