{% extends "base.html" %}

{% block title %}Claim Profile: {{ doctor.name }} - RankSewa{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Doctor Info Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h4 class="card-title mb-3">
                    <i class="fas fa-user-md me-2"></i>Claiming Profile For:
                </h4>
                <div class="d-flex align-items-center">
                    {% if doctor.photo_url %}
                    {% set photo_path = doctor.photo_url.replace('photos/', '') %}
                    <img src="{{ url_for('serve_photo', filename=photo_path) }}" alt="{{ doctor.name }}" class="rounded-circle me-3" width="80" height="80" onerror="this.src='{{ doctor|doctor_avatar }}'">
                    {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-user-md fa-2x"></i>
                    </div>
                    {% endif %}
                    <div>
                        <h5 class="mb-1">{{ doctor.name }}</h5>
                        <p class="mb-0 text-muted">
                            {{ doctor.specialty.name }} • {{ doctor.city.name }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Claim Option -->
        <div class="card shadow-sm mb-4" style="border: 2px solid #0d8abc; border-radius: 16px;">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2" style="font-weight: 700;">
                            <i class="fas fa-bolt me-2 text-primary"></i>Quick Claim - Start Editing Now
                        </h5>
                        <p class="text-muted mb-0">
                            Claim this profile immediately and start editing your information.
                            You can submit verification documents later to unlock all features.
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <form method="POST" action="{{ url_for('claim_profile_quick', doctor_id=doctor.id) }}" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check me-2"></i>Claim Now
                            </button>
                        </form>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Quick claim gives you: Edit Profile, View your public profile |
                        <strong>Verify later to unlock:</strong> Respond to reviews, Analytics, QR codes, Clinic connections
                    </small>
                </div>
            </div>
        </div>

        <div class="text-center mb-4">
            <span class="text-muted">— OR —</span>
        </div>

        <!-- Full Verification Form -->
        <div class="card shadow-sm" id="verification-section">
            <div class="card-body p-4">
                <h4 class="card-title mb-4">
                    <i class="fas fa-shield-alt me-2"></i>Get Verified Now
                </h4>

                <p class="text-muted mb-4">
                    Submit your verification documents to get the verified badge and unlock all dashboard features.
                    Review takes 2-3 business days.
                </p>

                <form id="verificationForm" method="POST" action="{{ url_for('claim_profile_submit', doctor_id=doctor.id) }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <!-- NMC Number -->
                    <div class="mb-4">
                        <label for="nmc_number" class="form-label">
                            <i class="fas fa-id-card me-2"></i>Nepal Medical Council (NMC) Registration Number *
                        </label>
                        <input type="text"
                               class="form-control"
                               id="nmc_number"
                               name="nmc_number"
                               value="{{ doctor.nmc_number or '' }}"
                               placeholder="e.g., NMC-12345"
                               required>
                        <small class="form-text text-muted">
                            Your official NMC registration number
                        </small>
                    </div>

                    <!-- Phone Number -->
                    <div class="mb-4">
                        <label for="phone_number" class="form-label">
                            <i class="fas fa-phone me-2"></i>Phone Number *
                        </label>
                        <input type="tel"
                               class="form-control"
                               id="phone_number"
                               name="phone_number"
                               placeholder="+977 98XXXXXXXX"
                               required>
                        <small class="form-text text-muted">
                            We'll use this to verify your identity
                        </small>
                    </div>

                    <!-- Email -->
                    <div class="mb-4">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope me-2"></i>Email Address *
                        </label>
                        <input type="email"
                               class="form-control"
                               id="email"
                               name="email"
                               value="{{ current_user.email if current_user }}"
                               {% if current_user %}readonly{% endif %}
                               required>
                        <small class="form-text text-muted">
                            {% if current_user %}
                            Using your registered email address
                            {% else %}
                            Professional email address for verification
                            {% endif %}
                        </small>
                    </div>

                    <!-- Practice Address -->
                    <div class="mb-4">
                        <label for="practice_address" class="form-label">
                            <i class="fas fa-map-marker-alt me-2"></i>Practice Address *
                        </label>
                        <textarea class="form-control"
                                  id="practice_address"
                                  name="practice_address"
                                  rows="2"
                                  placeholder="Your clinic/hospital address"
                                  required></textarea>
                    </div>

                    <!-- Practice City -->
                    <div class="mb-4">
                        <label for="practice_city_id" class="form-label">
                            <i class="fas fa-city me-2"></i>Practice City *
                        </label>
                        <select class="form-select" id="practice_city_id" name="practice_city_id" required>
                            <option value="">Select city...</option>
                            {% for city in cities %}
                            <option value="{{ city.id }}" {% if city.id == doctor.city_id %}selected{% endif %}>
                                {{ city.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3"><i class="fas fa-upload me-2"></i>Document Upload</h5>
                    <p class="text-muted small mb-4">
                        Upload a government-issued ID to verify your identity.
                        Accepted formats: JPG, PNG, PDF (max 10MB)
                    </p>

                    <!-- Government ID Upload -->
                    <div class="mb-4">
                        <label for="govt_id" class="form-label">
                            <i class="fas fa-id-card me-2"></i>Government ID (Citizenship/Passport/License) *
                        </label>
                        <input type="file"
                               class="form-control"
                               id="govt_id"
                               name="govt_id"
                               accept=".jpg,.jpeg,.png,.pdf"
                               required>
                        <small class="form-text text-muted">
                            Upload a clear photo of your citizenship, passport, or driver's license
                        </small>
                    </div>

                    <!-- Optional Documents -->
                    <div class="alert alert-light border">
                        <h6 class="mb-2"><i class="fas fa-lightbulb me-2"></i>Speed Up Verification (Optional)</h6>
                        <small class="text-muted">
                            Adding medical degree or practice license documents helps us verify you faster, but they're not required.
                        </small>
                    </div>

                    <!-- Medical Degree Upload (Optional) -->
                    <div class="mb-4">
                        <label for="medical_degree" class="form-label">
                            <i class="fas fa-graduation-cap me-2"></i>Medical Degree Certificate (Optional)
                        </label>
                        <input type="file"
                               class="form-control"
                               id="medical_degree"
                               name="medical_degree"
                               accept=".jpg,.jpeg,.png,.pdf">
                        <small class="form-text text-muted">
                            Helps us verify you faster
                        </small>
                    </div>

                    <!-- NMC Practice License Upload (Required) -->
                    <div class="mb-4">
                        <label for="practice_license" class="form-label">
                            <i class="fas fa-certificate me-2"></i>NMC Practice License <span class="text-danger">*</span>
                        </label>
                        <input type="file"
                               class="form-control"
                               id="practice_license"
                               name="practice_license"
                               accept=".jpg,.jpeg,.png,.pdf"
                               required>
                        <small class="form-text text-muted">
                            Upload your NMC registration certificate with photo ID visible
                        </small>
                    </div>

                    <hr class="my-4">

                    <!-- Privacy Notice -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-shield-alt me-2"></i>Privacy & Security</h6>
                        <small>
                            Your documents will be securely stored and only reviewed by our admin team for verification purposes.
                            We will never share your personal documents with third parties.
                        </small>
                    </div>

                    <!-- Ranksewa Network Opt-in -->
                    <div class="card mb-4" style="border: 2px solid var(--brand); border-radius: 12px; background: var(--brand-soft);">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ranksewa_network" name="ranksewa_network" checked>
                                <label class="form-check-label" for="ranksewa_network">
                                    <strong><i class="fas fa-calendar-check me-2" style="color: var(--brand);"></i>Join Ranksewa Network for Digital Appointments</strong>
                                </label>
                            </div>
                            <p class="text-muted small mb-0 mt-2 ms-4">
                                Enable patients to book digital appointments with you through Ranksewa. You agree to:
                            </p>
                            <ul class="text-muted small mb-0 mt-1 ms-4">
                                <li>Use patient information only for appointment care</li>
                                <li>Keep patient details confidential and secure</li>
                                <li>Respond promptly to appointment requests</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Age Verification -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="age_confirm" required>
                        <label class="form-check-label" for="age_confirm">
                            I confirm that I am at least 16 years old
                        </label>
                    </div>

                    <!-- Terms and Conditions Agreement -->
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="terms_agree" required>
                        <label class="form-check-label" for="terms_agree">
                            I certify that all information provided is accurate and I agree to RankSewa's
                            <a href="{{ url_for('terms') }}" target="_blank">Terms of Service</a> and
                            <a href="{{ url_for('privacy') }}" target="_blank">Privacy Policy</a>
                        </label>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>Submit for Verification
                        </button>
                        <a href="{{ url_for('claim_profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Search
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- What Happens Next -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-info-circle me-2"></i>What Happens Next?
                </h5>
                <ol class="mb-0">
                    <li class="mb-2">Your verification request will be submitted to our admin team</li>
                    <li class="mb-2">We'll review your documents and information (usually within 2-3 business days)</li>
                    <li class="mb-2">You'll receive an email notification once your profile is verified</li>
                    <li class="mb-0">After verification, you can log in to manage your profile and respond to reviews</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="verificationModalLabel">Verification needed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="verificationModalBody">
                Please upload your Government ID to continue.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const verificationModal = new bootstrap.Modal(document.getElementById('verificationModal'));
const verificationModalBody = document.getElementById('verificationModalBody');

function showVerificationModal(message) {
    verificationModalBody.textContent = message;
    verificationModal.show();
}

// File size validation
document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showVerificationModal('File size exceeds 10MB. Please upload a smaller file.');
                this.value = '';
            }
        }
    });
});

// Form validation
document.getElementById('verificationForm').addEventListener('submit', function(e) {
    const govtIdInput = document.getElementById('govt_id');

    if (!govtIdInput.files || govtIdInput.files.length === 0) {
        e.preventDefault();
        showVerificationModal('Please upload your Government ID to continue.');
        return false;
    }
});
</script>
{% endblock %}
